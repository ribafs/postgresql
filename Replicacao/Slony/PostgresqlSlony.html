<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html dir="ltr" xmlns="http://www.w3.org/1999/xhtml" lang="pt-br"><head profile="http://gmpg.org/xfn/11">


	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Postgresql « EEEEEE Jão!!!</title>

	<link rel="stylesheet" href="PostgresqlSlony_arquivos/style.css" type="text/css" media="screen">
	<link rel="stylesheet" href="PostgresqlSlony_arquivos/orange.css" type="text/css" media="screen">
	<link rel="pingback" href="http://joaocosme.wordpress.com/xmlrpc.php">

	<link rel="alternate" type="application/rss+xml" title="Feed de EEEEEE Jão!!! »" href="http://joaocosme.wordpress.com/feed/">
<link rel="alternate" type="application/rss+xml" title="EEEEEE Jão!!! »  Feed de comentários" href="http://joaocosme.wordpress.com/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="Feed da Categoria EEEEEE Jão!!! » Postgresql" href="http://joaocosme.wordpress.com/category/postgresql/feed/">
<script type="text/javascript">
/* <![CDATA[ */
function addLoadEvent(func){var oldonload=window.onload;if(typeof window.onload!='function'){window.onload=func;}else{window.onload=function(){oldonload();func();}}}
/* ]]> */
</script>
<link rel="stylesheet" href="PostgresqlSlony_arquivos/global.css" type="text/css">
<script type="text/javascript" src="PostgresqlSlony_arquivos/l10n.js"></script>
<script type="text/javascript" src="PostgresqlSlony_arquivos/jquery.js"></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://joaocosme.wordpress.com/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://joaocosme.wordpress.com/wp-includes/wlwmanifest.xml"> 
<link rel="index" title="EEEEEE Jão!!!" href="http://joaocosme.wordpress.com/">
<meta name="generator" content="WordPress.com">
<link rel="shortcut icon" type="image/x-icon" href="http://1.gravatar.com/blavatar/bff62c43070b2f83f87342b7d07d9077?s=16" sizes="16x16">
<link rel="icon" type="image/x-icon" href="http://1.gravatar.com/blavatar/bff62c43070b2f83f87342b7d07d9077?s=16" sizes="16x16">
<link rel="apple-touch-icon" href="http://1.gravatar.com/blavatar/1b5551b5cda379453923fe4828a78ca3?s=158">
	<style type="text/css">
	/* <![CDATA[ */
				div#likes { margin-top: 15px; }
		.like-button { border: 1px solid #eee; padding: 2px 6px; font-size: 13px; font-family: arial, tahoma, sans-serif; }
		#wpl-likebox { clear: left; font-size: 11px; font-family: arial, tahoma, verdana, sans-serif !important; min-height: 30px; margin: 10px 0 !important; padding: 5px 0 10px 0 !important; }
		#wpl-button { float: left; background: url( http://s2.wp.com/i/buttonbg.png ) top left repeat-x; margin-right: 7px; border: 1px solid #d4d4d4; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }
		#wpl-button a { color: #666 !important; line-height: 130% !important; text-decoration: none !important; outline: none; float: left; padding: 3px 6px 2px 24px !important; font-size: 11px !important; background: url( http://s1.wp.com/i/likestar.png ) 6px 49.8% no-repeat; }
		#wpl-button.liked { background: #feffce; border: 1px solid #f3e389; }
		#wpl-button.liked a { color: #ba871b !important; }
		#wpl-likebox #wpl-count { min-height: 25px; line-height: 130% !important; float: left; padding-top: 4px; }
		#wpl-likebox #wpl-avatars { clear: left; max-height: 98px; overflow: hidden; margin-top: 15px; line-height: 130% !important; }
		#wpl-likebox #wpl-avatars img { border: none !important; }
		#wpl-likebox #wpl-mustlogin { line-height: 14px !important; font-size: 11px; clear: left; margin-top: 5px; background: #f0f0f0; padding: 10px; width: 65%; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }
		#wpl-likebox #wpl-mustlogin a { color: #888; text-decoration: underline; }
		#wpl-likebox #wpl-mustlogin p { margin: 5px 0; padding: 0 }
		#wpl-likebox #wpl-mustlogin input.input { padding: 2px; background: #fff; font-size: 11px; font-family: inherit; border: 1px solid #ccc; -moz-box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1) inset; -webkit-box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1) inset; line-height: 12px; }
		#wpl-likebox #wpl-mustlogin input#wp-submit { border: 1px solid #ccc; font-size: 11px; background: #fafafa; repeat-x; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; padding: 2px 4px !important; line-height: 12px; }
		#wpl-likebox #wpl-mustlogin label { position: relative; cursor: text; }
		#wpl-likebox #wpl-mustlogin label span { position: absolute; top: 0px; left: 5px; padding: 0 !important; }
		#wpl-likebox #wpl-mustlogin label span { top /*\**/: -10px\9; }
	/* ]]> */
	</style>
	<link rel="openid.server" href="http://joaocosme.wordpress.com/?openidserver=1">
<link rel="openid.delegate" href="http://joaocosme.wordpress.com/">
<link rel="search" type="application/opensearchdescription+xml" href="http://joaocosme.wordpress.com/osd.xml" title="EEEEEE Jão!!!">
<link rel="search" type="application/opensearchdescription+xml" href="http://wordpress.com/opensearch.xml" title="WordPress.com">
	<script type="text/javascript" charset="utf-8">
		try{
			var id = location.hash.match( /\#\!\/entry\/(\d+)/ )[1];
			if ( id ) {
				window.location = "http://joaocosme.wordpress.com?p=" + id;
			};
		}catch( error ){
		}
	</script>		
<meta name="application-name" content="EEEEEE Jão!!!"><meta name="msapplication-window" content="width=device-width;height=device-height"><meta name="msapplication-tooltip" content="#!/bin/bash aventuras de um Nerd disfarçado de bombado..."><meta name="msapplication-task" content="name=Subscrever;action-uri=http://joaocosme.wordpress.com/feed/;icon-uri=http://1.gravatar.com/blavatar/bff62c43070b2f83f87342b7d07d9077?s=16"><meta name="msapplication-task" content="name=Sign up for a free blog;action-uri=http://wordpress.com/signup/;icon-uri=http://s2.wp.com/i/favicon.ico"><meta name="msapplication-task" content="name=Suporte WordPress.com;action-uri=http://support.wordpress.com/;icon-uri=http://s2.wp.com/i/favicon.ico"><meta name="msapplication-task" content="name=Fóruns WordPress.com;action-uri=http://forums.wordpress.com/;icon-uri=http://s2.wp.com/i/favicon.ico">
<link rel="stylesheet" type="text/css" id="gravatar-card-css" href="PostgresqlSlony_arquivos/hovercard.css"><link rel="stylesheet" type="text/css" id="gravatar-card-services-css" href="PostgresqlSlony_arquivos/services.css"></head><body>

<div id="container">
	<div id="sitename">
		<h1><a href="http://joaocosme.wordpress.com/">EEEEEE Jão!!!</a></h1>
		<h2>#!/bin/bash aventuras de um Nerd disfarçado de bombado…</h2>
	</div>

	<div id="mainmenu">
			<ul class="level1">
		<li><a href="http://joaocosme.wordpress.com/">Início</a></li>
		<li class="page_item page-item-2"><a href="http://joaocosme.wordpress.com/about/" title="Sobre!!">Sobre!!</a></li>
	</ul>
	</div>

<div id="wrap">
<div id="leftside">

	<ul>

<li id="categories-153663432" class="widget widget_categories"><h2 class="widgettitle">Categorias</h2>
		<ul>
			<li class="cat-item cat-item-4827"><a href="http://joaocosme.wordpress.com/category/banco-de-dados/" title="Ver todos os posts arquivados em Banco de dados">Banco de dados</a> (2)
</li>
	<li class="cat-item cat-item-463"><a href="http://joaocosme.wordpress.com/category/geral/" title="Só viagem do dia mesmo!">geral</a> (3)
</li>
	<li class="cat-item cat-item-610"><a href="http://joaocosme.wordpress.com/category/linux/" title="Ver todos os posts arquivados em Linux">Linux</a> (3)
</li>
	<li class="cat-item cat-item-15989 current-cat"><a href="http://joaocosme.wordpress.com/category/postgresql/" title="Ver todos os posts arquivados em Postgresql">Postgresql</a> (8)
</li>
	<li class="cat-item cat-item-1"><a href="http://joaocosme.wordpress.com/category/uncategorized/" title="Ver todos os posts arquivados em Uncategorized">Uncategorized</a> (5)
</li>
		</ul>
</li>
		<li id="recent-posts-2" class="widget widget_recent_entries">		<h2 class="widgettitle">Tópicos recentes</h2>
		<ul>
				<li><a href="http://joaocosme.wordpress.com/2010/04/07/pensamentos-07042010/" title="Pensamentos…&nbsp;07/04/2010">Pensamentos…&nbsp;07/04/2010</a></li>
				<li><a href="http://joaocosme.wordpress.com/2009/10/30/ha-em-postgresql-warm-stand-by-heartbeat-hapm/" title="HA em Postgresql = Warm Stand By + HeartBeat +&nbsp;HAPM">HA em Postgresql = Warm Stand By + HeartBeat +&nbsp;HAPM</a></li>
				<li><a href="http://joaocosme.wordpress.com/2009/09/10/a-journey-of-a-thousand-miles-must-begin-with-a-single-step/" title="A journey of a thousand miles must begin with a single&nbsp;step….">A journey of a thousand miles must begin with a single&nbsp;step….</a></li>
				<li><a href="http://joaocosme.wordpress.com/2009/08/10/flag-seen-problem-cyrus-all-messages-unread/" title="FLAG SEEN PROBLEM + CYRUS + ALL Messages&nbsp;Unread!">FLAG SEEN PROBLEM + CYRUS + ALL Messages&nbsp;Unread!</a></li>
				<li><a href="http://joaocosme.wordpress.com/2009/07/27/apache-load-balance-lenny/" title="Apache + Load Balance +&nbsp;Lenny">Apache + Load Balance +&nbsp;Lenny</a></li>
				</ul>
		</li>
<li id="archives-2" class="widget widget_archive"><h2 class="widgettitle">Arquivos</h2>
		<ul>
			<li><a href="http://joaocosme.wordpress.com/2010/04/" title="abril 2010">abril 2010</a></li>
	<li><a href="http://joaocosme.wordpress.com/2009/10/" title="outubro 2009">outubro 2009</a></li>
	<li><a href="http://joaocosme.wordpress.com/2009/09/" title="setembro 2009">setembro 2009</a></li>
	<li><a href="http://joaocosme.wordpress.com/2009/08/" title="agosto 2009">agosto 2009</a></li>
	<li><a href="http://joaocosme.wordpress.com/2009/07/" title="julho 2009">julho 2009</a></li>
	<li><a href="http://joaocosme.wordpress.com/2009/04/" title="abril 2009">abril 2009</a></li>
	<li><a href="http://joaocosme.wordpress.com/2009/03/" title="março 2009">março 2009</a></li>
	<li><a href="http://joaocosme.wordpress.com/2009/02/" title="fevereiro 2009">fevereiro 2009</a></li>
	<li><a href="http://joaocosme.wordpress.com/2008/09/" title="setembro 2008">setembro 2008</a></li>
	<li><a href="http://joaocosme.wordpress.com/2008/07/" title="julho 2008">julho 2008</a></li>
	<li><a href="http://joaocosme.wordpress.com/2008/06/" title="junho 2008">junho 2008</a></li>
		</ul>
</li>
<li id="calendar-2" class="widget widget_calendar"><h2 class="widgettitle">&nbsp;</h2>
<div id="calendar_wrap"><table id="wp-calendar" summary="Calendário">
	<caption>abril 2011</caption>
	<thead>
	<tr>
		<th scope="col" title="segunda-feira">S</th>
		<th scope="col" title="terça-feira">T</th>
		<th scope="col" title="quarta-feira">Q</th>
		<th scope="col" title="quinta-feira">Q</th>
		<th scope="col" title="sexta-feira">S</th>
		<th scope="col" title="sábado">S</th>
		<th scope="col" title="domingo">D</th>
	</tr>
	</thead>

	<tfoot>
	<tr>
		<td colspan="3" id="prev"><a href="http://joaocosme.wordpress.com/2010/04/" title="Ver posts de abril 2010">« abr</a></td>
		<td class="pad">&nbsp;</td>
		<td colspan="3" id="next" class="pad">&nbsp;</td>
	</tr>
	</tfoot>

	<tbody>
	<tr>
		<td colspan="4" class="pad">&nbsp;</td><td>1</td><td>2</td><td>3</td>
	</tr>
	<tr>
		<td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td>
	</tr>
	<tr>
		<td>11</td><td>12</td><td>13</td><td>14</td><td>15</td><td>16</td><td>17</td>
	</tr>
	<tr>
		<td>18</td><td>19</td><td>20</td><td>21</td><td>22</td><td>23</td><td>24</td>
	</tr>
	<tr>
		<td>25</td><td>26</td><td>27</td><td>28</td><td id="today">29</td><td>30</td>
		<td class="pad" colspan="1">&nbsp;</td>
	</tr>
	</tbody>
	</table></div></li>
<li id="wp_tag_cloud" class="widget wp_widget_tag_cloud"><h2 class="widgettitle">Tags</h2>
<div style="overflow: hidden;"><a href="http://joaocosme.wordpress.com/tag/bash/" class="tag-link-2674" title="1 tópico" style="font-size: 8pt;">bash</a>
<a href="http://joaocosme.wordpress.com/tag/postgresql/" class="tag-link-15989" title="1 tópico" style="font-size: 8pt;">Postgresql</a></div></li>
	</ul>
</div>
<!-- Right Sidebar Template -->
<div id="rightside">
	<ul>
	
		<li><form method="get" id="searchform" action="http://joaocosme.wordpress.com/">
<div><input id="searchbox" name="s" type="text">
<input id="searchbutton" value="Pesquisar" type="submit">
</div>
</form>
</li>
</ul>
<ul>
 </ul>
<ul>
 <li><h2>Meta</h2>
  <ul>
   <li><a href="http://joaocosme.wordpress.com/wp-login.php?action=register">Registrar-se</a></li>   <li><a href="http://joaocosme.wordpress.com/wp-login.php">Login</a></li>
     </ul>
 </li>
</ul>
<ul>
 <li><h2>Subscrever</h2>
  <ul>
   <li class="feed"><a href="http://joaocosme.wordpress.com/feed/">Entradas (RSS)</a></li>
   <li class="feed"><a href="http://joaocosme.wordpress.com/comments/feed/">Comentários (RSS)</a></li>
  </ul>
 </li>
</ul>
</div>

<div id="content">
								
      		<h1 class="pagetitle">Arquivo da categoria ‘Postgresql’ </h1>
      		<p><strong><em></em></strong></p>
       	  
	<div class="navigation">
		<div class="alignleft"></div>
		<div class="alignright"></div>
	</div>
		
			<div class="post-155 post type-post status-publish format-standard hentry category-banco-de-dados category-linux category-postgresql" id="post-155">
			<h2><a href="http://joaocosme.wordpress.com/2009/10/30/ha-em-postgresql-warm-stand-by-heartbeat-hapm/" rel="bookmark" title="Permanent link to HA em Postgresql = Warm Stand By + HeartBeat +&nbsp;HAPM">HA em Postgresql = Warm Stand By + HeartBeat +&nbsp;HAPM</a></h2>

			<p class="date">Posted by joaocosme em outubro 30, 2009</p>
                   
				<div class="entry">
					<h1>Prefácio hehehe</h1>
<p>Ja faz um bom tempo que eu gostaria de postar novamente, ando muito 
ocupado não sei se vocês sabem, mas estou no SERPRO em Porto Alegre 
agora envolvido não mais com o desenvolvimento em si do EXPRESSO&nbsp; 
mas com a&nbsp; a PRODUÇÃO!! Maravilha tudo o que eu queria….</p>
<p>AAAAA como é bom o cheiro dos servidores, aquele lindo terminal e 
finalmente Postgresql novamente …. O bom filho a casa retorna! 
Finalmente retornei com postgresql , não com a mesma exclusividade mas 
já é uma ótima!!</p>
<h1>Mandando o SALVE!!</h1>
<p>Galera gostaria de mandar um salve pros amigos que reencontrei no 
PGCON2009 e para os novas amizades que foram conquistadas , depois posto
 sobre o PGCON!!</p>
<p>Um salve pro meu brother Euler… esse já é irmão!!!</p>
<p>Um salve pro Minerin “Cara de coveiro”…</p>
<p>Um salve pro Léo Lindo e para a Cris….</p>
<p>Um salve pro Jovem “J”</p>
<p>Um salve pro Telles</p>
<p>Um salve pro Zé do Cleyssom de BSB (Agora convertido em Postgresql <img src="PostgresqlSlony_arquivos/icon_razz.gif" alt=":P" class="wp-smiley">  )</p>
<p>Um salve pro Diogo Biazus</p>
<p>Um salve pro pequeno inseto (Ele sabe quem é)</p>
<p>Um salve pro Roberto Mello (Cara 10 ….. PRAZER do Ca!@#$$# conhecer esse cabra)</p>
<p>Um salve pro Francisco , (Outro cara 10 …. que conheci tb em mais um evento)</p>
<p>Um salve pro GUTO de BSB….</p>
<p>Um salve pro “Rolon Boy” (Esse tb sabe quem é hehhe)</p>
<p>Um salve pro DUTRA.</p>
<p>Um salve pra Marisa (Valeu Marisaaaaaaaa……….. )</p>
<p>Um salve pro …. pra……</p>
<p>Um salve pro&nbsp; Galera do MEC ( O Rodrigão e o Marcelo)</p>
<p>Um salve pros brothers da CELEPAR( esqueci o nome foi mal)</p>
<p>Um salve pro Emanuel “EL Aprendiz” da Argentina !</p>
<p>Um salve pra geral que prestigiou o evento e a minha palestra!!</p>
<p style="text-align: center;"><span style="color: rgb(136, 136, 136);"><img class="aligncenter size-medium wp-image-184" title="2009-09-14-153739" src="PostgresqlSlony_arquivos/2009-09-14-153739.jpg" alt="2009-09-14-153739" height="225" width="300"></span></p>
<h1><strong>Voltando ao Post….</strong></h1>
<p>Vejo muita gente comentando sobre Replicação , alta disponibilidade, 
balanceamento de carga. Em vários eventos de SL são debatidos esses 
temas e como está na semana do PGCON 3 edição , acho que seria uma boa 
soltar um post de interesse de muita gente, pois é galera ai vai …. 
Vamos ganhar um dinheirinho com consultoria ai….</p>
<h1><strong>Cenário</strong></h1>
<p>Não irei entrar em conceitos como<strong> PITR, WAL</strong> , pá e 
bola…. Então são pré-requisitos para um bom entendimento!! Não que não 
consiga implementar sem esses conceitos mas véio de boa…. Estuda!! <img src="PostgresqlSlony_arquivos/icon_razz.gif" alt=":P" class="wp-smiley"> </p>
<h1>Um servidor primário e um servidor secundário.</h1>
<p>O&nbsp; servidor&nbsp; primário recebe as requisições&nbsp; feliz da 
vida&nbsp; e tranquilo , o servidor secundário fica em Stand-By em modo 
seca pimenteiro = on hehehe , pois ele não pode ser não pode ser 
acessado. Em um determinado momento meu servidor primário deixa de 
prover o serviço e…..</p>
<p>Meu servidor em Stand-by cheio de moral e doido para mostrar serviço,
 assume a posição&nbsp; do servidor primário de maneira&nbsp; 
“transparente” ao usuário… pois é … nem tudo é perfeito e o afobado 
jovem em stand by pode deixar um dado ou outro de lado <img src="PostgresqlSlony_arquivos/icon_razz.gif" alt=":P" class="wp-smiley"> </p>
<p>Nessa brincadeira ai&nbsp; já traçamos alguns conceitos importantes : <strong>Alta-disponibilidade
 , Replicação Síncrona e uma característica importante na implementação 
do stand-by (Não pode ser acessado nem para consulta)</strong></p>
<p><img class="aligncenter size-medium wp-image-156" title="HA-PG" src="PostgresqlSlony_arquivos/ha-pg.jpg" alt="HA-PG" height="171" width="312"></p>
<p>Para alcançar o objetivo iremos utilizar&nbsp; como coadjuvantes os softwares<strong> HAPM</strong> e o<strong> HeartBeat</strong> que nos possibilitaram a Alta-disponibilidade do serviço.</p>
<h1><strong>Configurando o Ambiente!</strong></h1>
<p>Anota ai jovem…</p>
<p><strong>Postgresql-8.3</strong><br>
<strong>postgresql-contrib-8.3 </strong><br>
<strong>heartbeat-2</strong><br>
<strong>nfs-kernel-server</strong><br>
<strong>hapm</strong></p>
<p>Vamos utilizar o<strong> Debian Lenny</strong> como exemplo e instalar os pacotes acima nas duas máquinas:</p>
<p><strong><em>apt-get install postgresql-8.3 heartbeat-2 nfs-kernel-server hapm&nbsp; postgresql-8.3-contrib</em></strong><strong> </strong></p>
<p><!-- 		@page { margin: 2cm } 		P { margin-bottom: 0.21cm } --></p>
<p style="margin-bottom: 0pt;">Uma vez instalados os pacotes nos dois servidores<span style="font-family: Arial;"> criaremos um local para arquivar os segmentos <strong><em>WAL</em></strong>. É altamente recomentados gravar os segmentos<strong> </strong><em><strong>WAL</strong> </em>remotamente do servidor primário, pois se o servidor primário cair , não teremos  acesso aos segmentos <strong>WAL</strong>, o que comprometeria a replicação e consequentemente a disponibilidade do sistema.</span></p>
<p><span style="font-family: Arial;"> Os arquivos  devem ter permissões 
de escrita e leitura para ambos os servidores. No exemplo que estamos 
demonstrando a técnica, criaremos um compartilhamento<strong> <em>NFS</em></strong> no servidor Stand By e o servidor primário exportará os arquivos<strong> WAL(cansei de colocar o Wal em negrito)</strong> para este determinado local. Tenha a certeza que o diretório pertença ao usuário postgres. Entendeu??</span></p>
<p><!-- 		@page { margin: 2cm } 		P { margin-bottom: 0.21cm } --></p>
<p style="margin-bottom: 0pt;">Criação do diretório na máquina slave&nbsp; para arquivamento&nbsp; no qual o usuário PostgreSQL pode escrever e ler:</p>
<p><!-- 		@page { margin: 2cm } 		P { margin-bottom: 0.21cm } --></p>
<p>Como usuário root:</p>
<p><strong><span style="font-family: Arial;"><em>mkdir /psql-archive </em></span></strong></p>
<p><strong><span style="font-family: Arial;"> <em>chown postgres.postgres /pgsql-archive </em></span></strong></p>
<p><strong><span style="font-family: Arial;"> <em> echo “/psql-archive IP_MASTER (rw,sync,no_subtree_check)” &gt;&gt; /etc/exports </em></span></strong></p>
<p><strong><span style="font-family: Arial;"> <em>exportfs -a </em></span></strong></p>
<p><strong><span style="font-family: Arial;"><em> su postgres -c “touch /psql-archive/mounted” </em></span></strong></p>
<p><strong><span style="font-family: Arial;"><em><br>
</em></span></strong></p>
<h1><strong><span style="font-family: Arial;">O que os comandos acima fazem??</span></strong></h1>
<p><span style="font-family: Arial;">Criamos um diretório chamado <strong>/psql-archive</strong> cujo o dono é o safadinho do usuário postgres e permitimos que a máquina </span><span style="font-family: Arial;">PRIMÁRIA</span><strong><span style="font-family: Arial;"> </span></strong><span style="font-family: Arial;">possa montar o diretório</span><strong><span style="font-family: Arial;"> </span></strong><span style="font-family: Arial;">remotamente podendo escrever e ler nele… já ia esquecer ,também criamos de ante-mão um arquivo lá no diretório chamado <strong>mounted</strong>… (aí está a mágica!!)</span></p>
<h1><strong>Agora na máquina primária</strong></h1>
<p><!-- 		@page { margin: 2cm } 		P { margin-bottom: 0.21cm } --></p>
<p style="margin-bottom: 0pt;"><strong><span style="font-family: Arial;"><em>mkdir /psql-archive </em></span></strong></p>
<p><strong><span style="font-family: Arial;"><em> chown postgres.postgres /psql-archive </em></span></strong></p>
<p><strong><span style="font-family: Arial;"><em> mount IP_SLAVE:/psql-archive /psql-archive </em></span></strong></p>
<p><strong><span style="font-family: Arial;"><em><br>
</em></span></strong></p>
<h1><strong><strong><span style="font-family: Arial;">O que os comandos acima fazem??</span></strong></strong></h1>
<p><strong> </strong></p>
<p><span style="font-family: Arial;">Agora na máquina primária criamos um diretório chamado<strong> /psql-archive</strong> cujo o dono&nbsp; é o postgres montamos remotamente o diretório da máquina slave psql-archive no <strong>/psql-archive</strong> do primário.</span></p>
<p><span style="font-family: Arial;"><br>
</span></p>
<h1><strong><span style="font-family: Arial;">Ainda na máquina primária iremos ativar o recurso de WALs :</span></strong></h1>
<p><!-- 		@page { margin: 2cm } 		P { margin-bottom: 0.21cm } --></p>
<p style="margin-bottom: 0pt;"><span style="font-family: Arial;"><em>no arquivo</em><span style="font-style: normal;"> </span><span style="font-style: normal;"><strong>/etc/postgresql/8.3/main/postgresql.conf </strong></span><em>alterar as seguintes linhas: </em></span></p>
<p><strong><span style="font-family: Arial;"><em> <span style="font-weight: normal;">archive_mode = on </span></em></span></strong><em> </em></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>
 archive_command = “test -f /psql_archive/mounted &amp;&amp; test ! -f 
/psql_archive/%f 		&amp;&amp; rsync -a %p /psql_archive/%f”</em></span></strong></p>
<p><span style="font-family: Arial;">Que lindo o archive_command!!! Fandásdigo como diria tiririca, confesso esse eu copiei&nbsp; hehehhe mas eu sei o que ele faz <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"> </span></p>
<p><span style="font-family: Arial;">Vamos por partes!!!</span></p>
<p><span style="font-family: Arial;">arvhice command = (condicao 1) &amp;&amp; (condicao 2)</span></p>
<p><span style="font-family: Arial;">Condição 1 = teste -f /psql/mounted </span></p>
<p><span style="font-family: Arial;"> Lembra do comando<strong> touch /psql/mounted</strong> no servidor seca pimenteiro, ops .. escravo?? O que ele faz é verificar se o arquivo <strong>mounted</strong> existe, se ele existir significa que a partição remota está montada&nbsp; <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"> <em> </em></span></p>
<p><span style="font-family: Arial;">Condição 2 = <em>test ! -f /psql_archive/%f 		&amp;&amp; rsync -a %p /psql_archive/%f </em></span></p>
<p><span style="font-family: Arial;">Verifica se já existe o arquivo Wall no secundário , se não existir ele copia o Wal file para lá <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"> </span></p>
<p><span style="font-family: Arial;">o “&amp;&amp;”,&nbsp; elementar meu caro as duas condições tem que serem válidas ou seja </span></p>
<p><span style="font-family: Arial;">(particao tem que estar montada ) e (nao deve existir o arquivo no diretorio la no escravo)<br>
</span></p>
<p style="font-weight: normal;">
</p><p style="font-weight: normal;"><span style="font-family: Arial;"><span style="font-style: normal;">Reiniciar o serviço do PostgreSQL</span></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><span style="font-style: normal;"> </span><strong><em>/etc/init.d/Postgresql-8.3 restart</em></strong></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;">A 
Partir deste momento meu caro parabéns, já está gerando arquivos Wals e o
 mais legal, lá no diretório do escravo… nossa imagina o cabra ter que 
suportar ter que ser secundário e neguin escrevendo no diretório dele 
hehehh.</span></p>
<h3>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;">Prova dos 9!</span></strong></p>
</h3>
<p style="font-weight: normal;"><span style="font-family: Arial;">Vamos lá… </span></p>
<p><!-- 		@page { margin: 2cm } 		P { margin-bottom: 0.21cm } --></p>
<p style="font-style: normal; font-weight: normal;"><span style="font-family: Arial;">Agora devemos fazer o backup básico do diretório <strong>$PGDATA</strong>, sem a necessidade de parar o banco de dados , isso no servidor primário logicamente.</span></p>
<p><!-- 		@page { margin: 2cm } 		P { margin-bottom: 0.21cm } --></p>
<p style="margin-bottom: 0pt; font-weight: normal;"><strong><span style="font-family: Arial;"><em>psql  -U postgres </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>Bem vindo ao psql 8.3.3, o terminal iterativo do PostgreSQL. </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>Digite:  \copyright para mostrar termos de distribuição </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>\h para ajuda com comandos SQL </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>\? para ajuda com comandos do psql </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>\g ou terminar com ponto-e-vírgula para executar a consulta </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>\q para sair </em></span></strong></p>
<p style="font-weight: normal;"><strong><br>
</strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>postgres=# select pg_start_backup(‘meu_backup’); </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>pg_start_backup </em></span></strong></p>
<p><!-- 		@page { margin: 2cm } 		P { margin-bottom: 0.21cm } --></p>
<p style="margin-bottom: 0pt; font-weight: normal;"><strong><span style="font-family: Arial;"><em>2/CE005F40 </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>(1 registro) </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>postgres=# \q </em></span></strong></p>
<p><!-- 		@page { margin: 2cm } 		P { margin-bottom: 0.21cm } --></p>
<p style="margin-bottom: 0pt; font-weight: normal;"><strong><span style="font-family: Arial;"><em># su – postgres </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em># cd /var/lib/Postgresql/8.3/ </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>$ tar -czf /psql-archive/base_backup.tar.gz * </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>tar: Removendo `/’ inicial dos nomes dos membros </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>tar: main/pg_xlog/0000000100000002000000CF: arquivo alterado enquanto estava sendo lido </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>….. </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>….. </em></span></strong></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>….. </em></span></p>
<p style="font-style: normal; font-weight: normal;"><span style="font-family: Arial;">Estamos gerando um backup a fisico do diretório de dados e colocando no diretório compartilhado <strong>/psql-archive</strong> . Uma vez terminado o backup, conectar no banco de dados e efetuar o seguinte comando: </span></p>
<p style="font-style: normal; font-weight: normal;">
</p><p><!-- 		@page { margin: 2cm } 		P { margin-bottom: 0.21cm } --></p>
<p style="margin-bottom: 0pt; font-weight: normal;"><strong><span style="font-family: Arial;"><em>psql  -U postgres -h localhost </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>Bem vindo ao psql 8.3.3, o terminal iterativo do Postgresql. </em></span></strong></p>
<p style="font-weight: normal;"><strong><br>
</strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>Digite:  \copyright para mostrar termos de distribuição </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>\h para ajuda com comandos SQL </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>\? para ajuda com comandos do psql </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>\g ou terminar com ponto-e-vírgula para executar a consulta </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>\q para sair </em></span></strong></p>
<p style="font-weight: normal;"><strong><br>
</strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>conexão SSL (cifra: DHE-RSA-AES256-SHA, bits: 256) </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>postgres=# select pg_stop_backup(); </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>pg_stop_backup </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>—————- </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>2/D000BC0C </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>(1 registro) </em></span></strong></p>
<p style="font-weight: normal;"><strong><br>
</strong></p>
<p style="margin-bottom: 0pt;"><strong><span style="font-family: Arial;"><em>postgres=# \q</em></span></strong></p>
<p style="margin-bottom: 0pt;"><strong><span style="font-family: Arial;"><em><br>
</em></span></strong></p>
<h1>
<p style="margin-bottom: 0pt;"><strong>Na máquina 			secundária novamente </strong></p>
</h1>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em> <strong>mv /var/lib/Postgresql/8.3/main /var/lib/Postgresql/8.3/main.old </strong></em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;">Estamos renomeando o $PGDATA da máquina secundária para $PGDATA.old<br>
</span></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em> mv /psql-archive/base_backup.tar.gz  /var/lib/Postgresql/8.3 </em></span></strong></p>
<p style="font-weight: normal;"><span style="font-family: Arial;">Copiando o backup do servidor primário para o diretório /<strong>var/lib/Postgresql;8.3</strong><br>
</span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em> <strong>tar -xzvf /var/lib/Postgresql/8.3 </strong></em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;">Mandando bala descompactando o danado…<em><br>
</em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em> <strong>cd /var/lib/Postgresql/8.3/main/ </strong></em></span></p>
<p><span style="font-family: Arial;">Entrando no diretório $PGDATA novo do secundário…<em><br>
</em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em> <strong>rm -Rf ./pg_xlog/* </strong></em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;">Removendo os arquivos do pg_xlog do primário…. <strong>Cansei…</strong></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;">Vamos vamos…. Vamos !!!!!</span></p>
<p><!-- 		@page { margin: 2cm } 		P { margin-bottom: 0.21cm } --></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em> </em><span style="font-style: normal;">Criação do arquivo </span><span style="font-style: normal;"><strong>recovery.conf</strong></span><span style="font-style: normal;"> na máquina para o modo contínuo de 				recovery dentro do $PGDATA ( /var/lib/Postgresql/8.3/main/) com a seguinte linha: </span></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em> <strong>restore_command = ‘</strong></em></span><strong>/usr/lib/postgresql/8.3/bin/<span style="font-family: Arial;"><em>pg_standby -d -l -r 3 -s 60 -t /psql_archive/trigger.done  /psql_archive 	%f %p %r 2&gt;&gt;/tmp/pg_standby.log’ </em></span></strong></p>
<p style="font-style: normal; font-weight: normal;"><span style="font-family: Arial;">Essa linha basicamente indica o Postgresql para continuar o <em>recovery</em> até encontrar um arquivo chamado <strong>/psql-archive/trigger.done</strong>,
 ou seja , quando o servidor primário cair, um arquivo trigger.done será
 criado e o procedimento da subida do servidor slave é iniciado.</span></p>
<p style="font-style: normal; font-weight: normal;"><span style="font-family: Arial;"><br>
</span></p>
<h1 style="font-style: normal; font-weight: normal;"><strong><span style="font-family: Arial;">Iniciando o servidor Stand by</span></strong></h1>
<p><!-- 		@page { margin: 2cm } 		P { margin-bottom: 0.21cm } --></p>
<p style="margin-bottom: 0pt; font-weight: normal;"><span style="font-family: Arial;"><em><strong>#&nbsp; /etc/init.d/Postgresql-8.3 start </strong></em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>* Starting Postgresql 8.3 database server </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>[ OK ] </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em> </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em># <strong>tail -f /tmp/pg_standby.log </strong></em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>Keep archive history    : 000000000000000000000000 and later </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>running restore         : OK </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>Trigger file            : /psql-archive/trigger.done </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>Waiting for WAL file    : 000000020000000200000088 </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>WAL file path           : /psql-archive/000000020000000200000088 </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>Restoring to…         : pg_xlog/RECOVERYXLOG </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>Sleep interval          : 60 seconds </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>Max wait interval       : 0 forever </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>Command for restore     : ln -s -f “/psql-archive/000000020000000200000088″ “pg_xlog/RECOVERYXLOG” </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>Keep archive history    : 000000000000000000000000 and later </em></span></p>
<p style="font-weight: normal;"><strong>Que lindo Que lindo …. Vamos Vamos…</strong></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em> </em><span style="font-style: normal;">Criação do arquivo </span><span style="font-style: normal;"><strong>recovery.conf</strong></span><span style="font-style: normal;"> na máquina para o modo contínuo de 				recovery dentro do $PGDATA ( /var/lib/Postgresql/8.3/main/) com a seguinte linha: </span></span></p>
<p style="font-weight: normal;">
</p><p style="font-weight: normal;"><span style="font-family: Arial;"><em> <strong>restore_command
 = ‘pg_standby -d -l -r 3 -s 60 -t /psql_archive/trigger.done  
/psql_archive 	%f %p %r 2&gt;&gt;/tmp/pg_standby.log’ </strong></em></span></p>
<p style="font-weight: normal;">
</p><p style="font-style: normal; font-weight: normal;"><span style="font-family: Arial;">Essa linha basicamente indica o Postgresql para continuar o <em>recovery</em> até encontrar um arquivo chamado <strong>/psql-archive/trigger.done</strong>,
 ou seja , quando o servidor primário cair, um arquivo trigger.done será
 criado e o procedimento da subida do servidor slave é iniciado.</span></p>
<p style="font-style: normal; font-weight: normal;"><span style="font-family: Arial;"><br>
</span></p>
<p><!-- 		@page { margin: 2cm } 		P { margin-bottom: 0.21cm } --></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>#psql  -U postgres -h localhost </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>psql: FATAL:  o sistema de banco de dados está iniciando ou seja esta em restore continuo.</em></span></strong></p>
<p style="font-weight: normal;">????? Num intindi nada!!!???</p>
<p style="margin-bottom: 0pt;"><span style="font-family: Arial;">O servidor está em <em>restore </em>constante!!!! Não temos como acessar o servidor (WARM Stand by Falei isso lá em cimaaa nocomeço do Post)</span></p>
<h1>
<p style="margin-bottom: 0pt;"><strong>Gerando arquivos 			Wals para serem replicados a partir do host primário</strong></p>
</h1>
<p style="font-style: normal; font-weight: normal;"><span style="font-family: Arial;">Começaremos a gerar alguns arquivos Wals .</span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>#<strong> psql  -U postgres </strong></em></span></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>Bem vindo ao psql 8.3.3, o terminal iterativo do Postgresql. </em></span></strong></p>
<p style="font-weight: normal;"><strong><br>
</strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>Digite:  \copyright para mostrar termos de distribuição </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>\h para ajuda com comandos SQL </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>\? para ajuda com comandos do psql </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>\g ou terminar com ponto-e-vírgula para executar a consulta </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>\q para sair </em></span></strong></p>
<p style="font-weight: normal;"><strong><br>
</strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>postgres=# create table teste as select * from pg_class, pg_attribute; </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>SELECT </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>postgres=# create table teste1 as select * from pg_class, pg_attribute; </em></span></strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>SELECT </em></span></strong></p>
<p style="font-weight: normal;"><strong><br>
</strong></p>
<p style="font-weight: normal;"><strong><span style="font-family: Arial;"><em>postgres=#\q </em></span></strong></p>
<p style="font-weight: normal;">
</p><p style="font-style: normal; font-weight: normal;"><span style="font-family: Arial;">Vários arquivos Wals foram gerados e gravados no diretório especificado no <em><strong>archive_command</strong>, </em>configuração do servidor que no caso, mais uma vez pra não se perder&nbsp; o tal <strong>/psql-archive</strong> que está montado na máquina primária .<br>
</span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em># <strong>ls -l /psql-archive<br>
</strong></em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>total 738184 </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:31 0000000100000002000000CE </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres      246 2009-10-06 16:35 0000000100000002000000CE.00005F40.backup </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:33 0000000100000002000000CF </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:35 0000000100000002000000D0 </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:37 0000000100000002000000D1 </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:39 0000000100000002000000D2 </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:41 0000000100000002000000D3 </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:43 0000000100000002000000D4 </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:45 0000000100000002000000D5 </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:47 0000000100000002000000D6 </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:49 0000000100000002000000D7 </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:51 0000000100000002000000D8 </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:51 0000000100000002000000D9 </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:51 0000000100000002000000DA </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:51 0000000100000002000000DB </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:51 0000000100000002000000DC </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:51 0000000100000002000000DD </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:51 0000000100000002000000DE </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:51 0000000100000002000000DF </em></span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:51 0000000100000002000000E0 </em></span></p>
<p style="margin-bottom: 0pt;"><span style="font-family: Arial;"><em>-rw——- 1 postgres postgres 16777216 2009-10-06 16:51 0000000100000002000000E1</em></span></p>
<p style="margin-bottom: 0pt;"><span style="font-family: Arial;"><em><br>
</em></span></p>
<p style="margin-bottom: 0pt;">
</p><h1>
<p style="margin-bottom: 0pt;"><strong>Testando a 	replicação para a máquina em Stand By</strong></p>
</h1>
<p style="font-style: normal; font-weight: normal;"><span style="font-family: Arial;">Agora criaremos o arquivo <em>/tmp/trigger.done. </em></span></p>
<p><span style="font-family: Arial;"><em><strong>touch /psql-archive/trigger.done </strong></em></span></p>
<p style="font-style: normal; font-weight: normal;"><span style="font-family: Arial;">Neste momento, o servidor<em> Stand By </em>detectará que deve sair do modo<em> recovery</em> e levantar o serviço.<strong> </strong>Ou seja, quando o arquivo <strong>/psql-archive/trigger.done</strong> existir, o servidor em  Stand By sai do modo <em>recovery </em>e passa a operar normalmente.<strong> </strong> Você pode logar no servidor Stand By e verificar as tabelas criadas. </span></p>
<p style="font-style: normal; font-weight: normal;">
</p><h1 style="font-style: normal; font-weight: normal;"><span style="font-family: Arial;">To be continued…</span></h1>
<p style="font-style: normal; font-weight: normal;"><span style="font-family: Arial;">Até
 agora implementamos o Warm Stand by… Sem alta disponibilidade…..&nbsp; o
 próximo post mostro como garantir a disponibilidade de forma que o 
servidor escravo assuma o ip do outro servidor mantendo a 
disponibilidade do serviço…<br>
</span></p>
<p style="font-style: normal; font-weight: normal;"><span style="font-family: Arial;"><br>
</span></p>
<p style="font-weight: normal;"><span style="font-family: Arial;"><em><br>
</em></span></p>
				</div>
                    
			<p class="category">Enviado em <a href="http://pt-br.wordpress.com/tag/banco-de-dados/" title="Ver todos os posts em Banco de dados" rel="category tag">Banco de dados</a>, <a href="http://pt-br.wordpress.com/tag/linux/" title="Ver todos os posts em Linux" rel="category tag">Linux</a>, <a href="http://pt-br.wordpress.com/tag/postgresql/" title="Ver todos os posts em Postgresql" rel="category tag">Postgresql</a> |    <a href="http://joaocosme.wordpress.com/2009/10/30/ha-em-postgresql-warm-stand-by-heartbeat-hapm/#comments" title="Comentário para HA em Postgresql = Warm Stand By + HeartBeat +&nbsp;HAPM">8 Comentários »</a></p>
		</div>
	
			<div class="post-21 post type-post status-publish format-standard hentry category-postgresql" id="post-21">
			<h2><a href="http://joaocosme.wordpress.com/2009/04/01/comecando-com-o-londiste/" rel="bookmark" title="Permanent link to Começando com o&nbsp;Londiste…">Começando com o&nbsp;Londiste…</a></h2>

			<p class="date">Posted by joaocosme em abril 1, 2009</p>
                   
				<div class="entry">
					<p>Mais uma vez resolvi dedicar um tempinho e mexer com as 
ferramentas do SkyTools, o Londiste. Esse post já tem quase um ano , 
estava nos seus 80% mas por motivos maiores de falta de tempo, trampo ….
 e vcs sabem a “caixa é uma vidinha de surpresas”…</p>
<p>Aproveitando a proximidade do PGDAY ,um dia dedicado ao nosso querido
 Postgresql&nbsp; (Estou realmente pensando em bolar alguma palestra 
com&nbsp; PL/PROXY e Londiste aqui no PGDAY de Porto Alegre) , resolvi 
terminar de escrever sobre o londiste, e como promessa é dívida….</p>
<p>Primeiro foi o plproxy agora é a vez do londiste. Não esqueci não, 
vou postar algumas coisinhas que eu fiquei de postar do plproxy, 
inclusive testes de estress em cima dele, mas como a curiosidade falou 
mais alto,resolvi passar para o Londiste. A intenção é a seguinte:</p>
<p>Pegar o básico do PLPROXY, Londiste e PGBouncer (próximo post).  
Depois de um how to em cima de cada um deles montar um ambiente com os 3
 e meter BALA!</p>
<p>As primeira impressões que eu tive do  do londiste foram as seguintes:</p>
<h3>Documentação:</h3>
<p>Se a documentação do PLPROXY não era das melhores a do Londiste 
xiiiiiiiiiiii, lascou tudo, sinceramente uma negação, e vi os mesmos 
comentários dos gringos também Muito mal documentado mesmo!!!</p>
<h3>Instalação:</h3>
<p>A instalação foi um tanto penosa, perdi algumas horinhas mesmo 
batendo cabeça e pra não cometer novamente os erros eu documentei, ou 
pelo menos acho que documentei hehehe. Para quem não é perseverante, é 
desistência na certa!!!! E mais uma vez vi gringo reclamar!</p>
<h3>Implementação:</h3>
<p>Colocar o londiste pra rodar e ver suas bases de dados replicando é 
muito, mas muito simples mesmo.  Chega a ser ridículo ( depois de passar
 pela instalação….), é estremamente simples e chega ser 
recompensador!!!!</p>
<p>Então que comece a temporada do Londiste!!!!</p>
<h1><strong>O que é replicação???</strong></h1>
<p>Bem, como esse post não é sobre replicação em si, e mais precisamente sobre o Londiste não vamos entrar em todo o mérito!!!</p>
<p>O objetivo de um mecanismo de replicação de dados é permitir a 
manutenção de de várias cópias idênticas de um mesmo dado em vários 
servidores de banco de dados (SGBD).</p>
<h1><strong>Para que serve a replicação???</strong></h1>
<h2>Principais benefícios da replicação de dados são:</h2>
<p>Redundância.<br>
Possibilidade de um balanceamento de carga.<br>
Tornar o sistema menos sensível as falhas.</p>
<p>Sugiro que você jovem de uma lidinha sobre replicação ok?? hehhe eu quero é postar sobre o londiste!!!!</p>
<h1>É Pra que serve o Londiste??</h1>
<p>O Londiste é uma ferramenta para replicação assíncrona, 
master-to-slaves. Assíncrona significa que: Quando o nó master receber 
uma transação, existe um tempo para essa transação ser replicada nos nós
 slaves. O contrário disso , a replicação síncrona, ocorre quando as 
transações ocorrem em todos os nós on-line.</p>
<h1><strong>E como eu poderia usar o Londiste??</strong></h1>
<p>Hum deixa eu ver…. Onde não fosse necessário o espelhamento dos dados
 em todos os nós ao mesmo tempo??  Isso depende muito do projeto em 
questão. As vezes tenho somente 2 servidores de banco de dados, um 
servidor MASTER que recebe todas as transações e um servidorzinho na 
senzala, SLAVE que fica lá jogado esperando por receber os dados, depois
 que o Master fez uso …. As vezes tenho um servidor master e vários 
servidores slaves….. Então necessitou de dados repetidos em vários 
servidores, REPLICAÇÂO. Se não possui como pré-requisito que os dados 
sejam replicados instataneamente ,ASSÍNCRONO.<br>
Nunca se esquecer que eu tenho somente um MASTER e vários SLAVES. Tudo 
que acontece, o Master é quem manda… já viu escravo mandar no mestre??</p>
<h1><strong>AAAAA mas o Slony faz isso não????</strong></h1>
<p>Faz sim , slony faz até mais  por permitir cascateamento entre os nós
 e slave promotion. Ou seja no slony você tem um nó MASTER e outros nós 
slaves, mas esses nós slaves podem ser Providers para outros nós, 
cascateando assim os servidores.</p>
<p><strong><br>
</strong></p>
<h1><strong>Mas se o Slony tem mais recursos por que eu utilizaria o Londiste??</strong></h1>
<p>O londiste é muito mais simples de configurar e gerenciar, muito 
mesmo!!!! Antes o projeto Skype utilizava o próprio Slony, depois 
começaram a utilizar o Londiste, que foi desenvolvido por eles mesmos.<br>
Motivos!!!! Como já disse, facilidade de configurar e principalmente gerenciar.</p>
<p>Não tá acreditando né? Então toma!!!<br>
Trecho de uma discursão sobre Slony X londiste<br>
….<br>
“I have not been running slony for quite a long time. I last used it at<br>
Skype a few years ago before we moved to our own implementation -<br>
Londiste/pgQ from SkyTools. The main reason was that our cluster got too<br>
big to manage with slony. “<br>
….</p>
<h1><strong>Beleza então vamos começar a instalação!!!!</strong></h1>
<p>Como eu disse no início do post, o grande problema do Londiste, como 
todos to Skytools é a documentação. Eu estou utilizando o debian 4.0.</p>
<p>Depois de bater muito a cabeça acabei instalando alguns pacotes a mais:</p>
<p><em><strong>apt-get install build-essential python-psycopg libevent-dev  python-all-dev python-all python-support</strong></em></p>
<p>Uma vez instalados esses pacotes, vamos baixar o código fonte:<br>
<em><strong>http://pgfoundry.org/frs/download.php/1813/skytools-2.1.7.tar.gz</strong></em></p>
<p>baixado o código fonte no meu diretório /usr/src:<br>
<em><strong>tar -xzvf skytools-2.1.7.tar.gz</strong></em><br>
<em><strong><br>
./configure –with-pgconfigdir=/usr/local/pgsql/bin </strong> </em>(No meu caso ok?? deve-se setar o diretório do seu pg_config)<br>
<strong><br>
<em>make &amp;&amp; make install</em></strong><em></em></p>
<p>Se o bicho não reclamou de nada beleza!!! Se reclamou aí vamos ter que sambar um pouco….<br>
Pelo o que eu me lembre esses foram os pacotes que eu instalei, eu instalarei do zero novamente pra fazer a prova dos 9 <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<p>PS: O jovenzinho, ele sabe quem é…. vai falar, já tem o pacote no debian http://packages.debian.org/sid/skytools<br>
Olha o garotinho aí né ??? mas  não ta na versão stable ainda …. Detalhe: ele mantém o pacote <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<h1><strong>Criando o Ambiente!!!</strong></h1>
<p>Vamos fazer o seguinte: Iremos criar inicialmente 2 databases, um master e outro slave</p>
<p>create database mestre;<br>
create database escravo;</p>
<p>Em cada database iremos criar 2 tabelas:<br>
<em><strong>create table tabela1(id serial primary key,nome text);<br>
create table tabela2(id serial primary key,nome text);</strong></em></p>
<p>Um detalhe muito importante!!!!! Todas as tabelas devem ter <em><strong>chaves primárias ok</strong></em>??? Não se esqueça disso. Atenção nisso jovem!</p>
<p>O que vai acontecer: Nós iremos realizar algumas operações no banco 
de dados mestre e elas vão ser replicadas ao banco de dados escravo.</p>
<h1><strong>Criando o primeiro CLUSTER</strong></h1>
<p>Como eu disse a configuração do londiste é muito simples mesmo. Vamos lá:</p>
<h3>Crie um arquivo chamado <strong>replicacao.conf </strong>com o seguinte conteudo:</h3>
<p>[londiste]<br>
job_name = replic</p>
<p>provider_db = dbname=mestre host=localhost user=postgres<br>
subscriber_db = dbname=escravo host=localhost user=postgres</p>
<p>pgq_queue_name = londiste_replic</p>
<p>pidfile = /tmp/pid.%(job_name)s<br>
logfile = /tmp/log.%(job_name)s</p>
<p>loop_delay = 1</p>
<p>connection_lifetime = 30</p>
<h3>Crie um arquivo chamado ticker.ini com o seguinte conteúdo:</h3>
<p>[pgqadm]</p>
<p>job_name = ticker</p>
<p>db = dbname=mestre user=postgres host=localhost</p>
<p>maint_delay_min = 1</p>
<p>loop_delay = 0.5</p>
<p>logfile = /tmp/log.%(job_name)s<br>
pidfile = /tmp/pid.%(job_name)s</p>
<p>use_skylog = 0</p>
<p>connection_lifetime = 21</p>
<p>queue_refresh_period = 10</p>
<h1>Instalando o Londiste no sevidor mestre</h1>
<p>Devemos instalar toda a estrutura para o londiste rodar: A instalação
 deve ser feita tanto no servidor mestre como no servidor escravo. Essa 
estrutura consiste em instalar a linguagem plpgsql,plpython…</p>
<p><em><strong>londiste.py replicacao.conf  provider install</strong></em></p>
<p>Detalhe: <strong>provider</strong><em> o nó que é origem da replicação!</em></p>
<h1>Instalando o Londiste no servidor escravo</h1>
<p>&lt;Em cada um dos nós escravos devemos também instalar toda a estrutura necessária como descrito acima.<br>
<strong><br>
<em>londiste.py replicacao.conf subscriber install</em></strong></p>
<p>Detalhe: <strong>subscriber é </strong>o nó escravo!</p>
<h1>Colocando  o PGQ pra rodar…</h1>
<p>O Daemon pgqadm deve rodar no servidor master , ele vai ser o cara 
responsável pelo mecanismo de transporte para implementar a replicação!</p>
<p><em><strong>pgqadm.py -d ticker.ini ticker</strong></em><br>
para verificar se realmente esta rodando o processo vamos dar um ps aux | grep pgq</p>
<p>…..<br>
root     28190  0.0  0.2  19248  4780 ?        Ssl  14:20   0:00 /usr/bin/python /usr/local/bin/pgqadm.py -d ticker.ini ticker<br>
….</p>
<p>Olha que bicho danado hehehehe!!<br>
hummm… posso também dar um<strong> pgqadmin.py  -d ticker.ini  status</strong><em> ,</em> tenta aí jovem!</p>
<p>Então pra encher o saco e memorizar!!! rodar o daemon pgqadmin no 
master utilizando o parametro -d ( o -d e pra rodar como daemon) 
passando o arquivo de configuracao ticker.ini  e a opcao ticker.</p>
<p>Se eu quizer parar o daemon<em>:<strong> pgqadmin.py&nbsp; -s ticker.ini </strong></em><br>
Curioso? lista o processo novamente!<br>
Memorize os parâmetros e como exercício levante e suba umas 1000 vezes.</p>
<h1>Colocando o daemon de replicação no ar!</h1>
<p>Você precisa rodar o deamon de replicação em cada host, como no nosso
 caso o host provider e subscriber estão na mesma máquina vamos la!</p>
<p><em><strong>londiste.py -d replicao.ini replay</strong></em></p>
<p>ps  aux | egrep “lond|pgq”</p>
<p>root     28568  0.0  0.2  11332  4860 ?        Ss   14:59   0:00 
/usr/bin/python /usr/local/bin/londiste.py -d replicacao.ini replay<br>
root     28693  0.0  0.2  19244  4772 ?        Ssl  15:05   0:00 /usr/bin/python /usr/local/bin/pgqadm.py -d ticker.ini ticker<br>
root     28725  0.0  0.0   3020   816 pts/0    R+   15:06   0:00 egrep lon|pgq</p>
<p>Exatamente os caras que eu estava esperando o pgqadm ( que é o cara 
que fica no master e) o londiste.py ( que é o cara que roda em cada 
escravo)</p>
<h1>Escolhendo os objetos as serem replicados</h1>
<p>Seguindo o nosso roteiro ja temos os deamons rodando no nó provider e
 nos nós subscribers. Devemos informar ao Londiste quais tabelas e 
sequences devemos replicar.</p>
<p>No nosso exemplo iremos replicar 2 tabelas: tabela1 e tabela2.</p>
<p>No nó de origem devemos executar o seguinte comando:</p>
<p><em><strong>londiste.py&nbsp;&nbsp; replicacao.conf&nbsp; provider add&nbsp; tabela1</strong></em></p>
<p><em><strong>londiste.py&nbsp; replicacao.conf&nbsp; provider add tabela2</strong></em></p>
<p>Também temos que replicar as sequences criadas pelo campo serial!!!</p>
<p><em><strong>londiste.py replicacao.conf provider add-seq tabela1_id_seq;</strong></em></p>
<p><em><strong>londiste.py replicacao.conf provider add-seq tabela2_id_seq;</strong></em></p>
<p>Po mas nao apareceu mensagem nenhuma pra mim? Está tudo tão obscuro!!!</p>
<p>beleza&nbsp; jovem mancebo…. faz o seguinte</p>
<p><em><strong>londiste.py replicacao.conf provider tables</strong></em></p>
<p>public.tabela2<br>
public.tabela1</p>
<p><em><strong>londiste.py replicacao.conf provider seqs</strong></em></p>
<p>public.tabela2_id_seq<br>
public.tabela1_id_seq</p>
<p><em><strong><br>
</strong></em></p>
<p>Detalhe na palavra provider!!!</p>
<p>Agora o mesmo procedimento nos nós de origem!!</p>
<p><em><strong>londiste.py&nbsp;&nbsp; replicacao.conf&nbsp; subscriber add&nbsp; tabela1</strong></em></p>
<p><em><strong>londiste.py&nbsp; replicacao.conf&nbsp; subscriber add tabela2</strong></em></p>
<p><em><strong>londiste.py replicacao.conf&nbsp; subscriber add-seq tabela1_id_seq;</strong></em></p>
<p><em><strong>londiste.py replicacao.conf&nbsp; subscriber&nbsp; add-seq tabela2_id_seq;</strong></em></p>
<p>Para dar aquela conferida básica….</p>
<p><em><strong>londiste.py replicacao.conf&nbsp; subscriber tables</strong></em></p>
<p>public.tabela2<br>
public.tabela1</p>
<p><em><strong>londiste.py replicacao.conf subscriber seqs</strong></em></p>
<p>public.tabela2_id_seq<br>
public.tabela1_id_seq</p>
<p>Detalhe na palavra subscriber!!</p>
<h1>Enfim Replicando……UFA!</h1>
<p>Vamos testar agora se a replicação vai funfar ou não, o cabra le o 
artigo se irrita e quer logo ver a parada funcionar, pelo menos eu sou 
assim <img src="PostgresqlSlony_arquivos/icon_razz.gif" alt=":P" class="wp-smiley"> </p>
<p>Suponha que seu psql esteja no seu PATH e vc esteja usando linux <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"> . AAAAAAAAAAAAAAA beleza então insere na mão mesmo se preferir!! <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<p>for i in $(seq 1 10000) ; do psql -U postgres -h localhost -c “insert into tabela1 values(default,’joao$i’)” mestre ; done</p>
<p>Com isso inserimos 10000 registros na tabela1. Após&nbsp; a inserção dos registros!!</p>
<p>Conecte-se no banco mestre e rode um count(*) na tabela1</p>
<p>Conecte-se no banco de dados escravo e rode um count(*) na tabela2</p>
<p>psql&nbsp; -U postgres -h localhost -c “select count(*) from tabela1″ mestre</p>
<p>psql&nbsp; -U postgres -h localhost -c “select count(*) from tabela1″ escravo</p>
<h1>Consideração finais…</h1>
<p>Fica pra amanhã estou realmente cansado…. Eu prometo que faço e não vai demorar quase um ano!<br>
 <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
				</div>
                    
			<p class="category">Enviado em <a href="http://pt-br.wordpress.com/tag/postgresql/" title="Ver todos os posts em Postgresql" rel="category tag">Postgresql</a> |    <a href="http://joaocosme.wordpress.com/2009/04/01/comecando-com-o-londiste/#comments" title="Comentário para Começando com o&nbsp;Londiste…">5 Comentários »</a></p>
		</div>
	
			<div class="post-25 post type-post status-publish format-standard hentry category-postgresql" id="post-25">
			<h2><a href="http://joaocosme.wordpress.com/2008/09/22/configurando-o-slony-na-manha/" rel="bookmark" title="Permanent link to Configurando o Slony na&nbsp;manha…">Configurando o Slony na&nbsp;manha…</a></h2>

			<p class="date">Posted by joaocosme em setembro 22, 2008</p>
                   
				<div class="entry">
					<p>Faz uns 2 anos que eu escrevi um <a href="http://devlog.waltercruz.com/media/blogs/devlog/slony.sh" target="_blank">script em shell</a>
 para facilitar a vida na configuração do slony-I. Bem, para quem ja 
mecheu com o Slony, ele tem uma linguagemzinha propria de configuração o
 slonik (chamado de pequeno elefante). Então … para configurar o slony 
eu tenho que saber o básico do slonik hehehe!!!</p>
<p>O problema de se configurar o slony, na minha opinião é que se você 
tiver várias, tabelas, sequences no seu banco de dados, que é comum 
encontrarmos um banco com 300 tabelas e tanana e tanana entao no seu 
arquivo de CONF você terá uma entrada para cada tabela ou sequence 
replicada… e como ja foi dito existe uma sintaxe toda própria para tal 
tipo de configuracao.</p>
<p>PS: O Script é só um ponta-pé inicial para a configuração do slony, e
 não uma interface de gerenciamento do mesmo. Você pode alterar o código
 fonte e melhorá-lo, sim ele precisa de melhorias hehehhe, portanto 
sinta-se a vontade!!!! HÁAA eu nao coloquei no codigo fonte mas é GPL , 
vou colocar o mais rapido</p>
<h3><strong>Mas para que serve o danado do Script?</strong></h3>
<p>Bem … para faciltar!!!! <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<p>O bom do script é que ele é baseado em DIALOG, ou seja preenchendo as
 caixas de dialogo você vai configurando o slony intuitivamente sem a 
necessidade de meter as mãos nos Confs. Ou seja, Com menus e outros 
objetos você seleciona quais os bancos de dados deseja replicar, quais 
as tabelas que serão replicadas, quais as sequences, e o mais legal, <strong>qual será a topologia do seu Cluster.</strong></p>
<p>Pode parecer mágica, magia negra, curandeirismo mas não é hehehhe. 
Sim você terá um banco de dados replicado em menos de um minuto não 
importanto a quantidade de objetos que devam ser replicados e ainda de 
brinde MAN ganhas um “OOOOO mas como você fez isso tão rápido” do seu 
chefe!!!</p>
<h3><strong>Replicando um banco de dados Postgresql em menos de 1 minuto!!!!</strong></h3>
<h3><strong>Pré-requisito</strong></h3>
<p>O pré-requisito não entra no 1 minuto hehehhe!!! Logicamente são os mesmos pré-requisitos do Slony-I</p>
<p>Postgresql instalado em cada nó.</p>
<p>slony-I instalado em cada nó.</p>
<p>o pacote Dialog instalado em um computador para gerar a configuração 
de preferência em um dos nós. (O script utiliza o Dialog como ja foi 
dito)</p>
<p>No nó que for rodar o script, certifique-se que o psql esteja no $PATH (preguiça minha mas vou alterar isso no script hehehhe)</p>
<h3><strong>Preparando o ambiente</strong>no seu banco de dados</h3>
<h3>crie um banco de dados chamado bd1 e bd2;</h3>
<p>create database bd1;<br>
create database bd2;</p>
<p>De suporte a plpgql em cada um dos bancos de dados… Lição de casa, se vc esta querendo mecher com slony entao isso tranquilo….</p>
<p>No nosso exemplo vamos replicar somente 2 bancos de dados em um mesmo computador, questões de muuuuita preguiça mesmo.</p>
<p>Vamos criar 20 tabelas em cada banco de dados da seguinte forma 
tabela1…. tabela20 com os seguinte campo tabela1(id integer primary 
key)…… Isso é só para ilustraaaaaaaaar gente!;</p>
<p><strong>for i in $(seq 1 20)<br>
do<br>
psql -U postgres -h localhost -c ” create table tabela$i(id integer primary key)” bd1;<br>
psql -U postgres -h localhost -c ” create table tabela$i(id integer primary key)” bd2;<br>
done</strong></p>
<p>Beleza bd1 e bd2 criados ambos com 20 tabelas!!!!<br>
To com ódio na ferramenta, como diria o filósofo MC catra!!! Então bora nessa.<br>
Com o script em maos, de permissao no danado de execução e rode ele!!</p>
<h3><strong>Rodando o Script!!!</strong></h3>
<p>./slony.sh</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony1.png"><img class="alignnone size-full wp-image-26" title="slony1" src="PostgresqlSlony_arquivos/slony1.png" alt="" height="768" width="1024"></a></p>
<p>Informe um nome para o cluster: primeiro_cluster<br>
Esse não é um how to sobre slony, entao nao vou explicar muito…. Ta bom….. todo um cluster do slony tem que ter um nome ok?:</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony2.png"><img class="alignnone size-full wp-image-27" title="slony2" src="PostgresqlSlony_arquivos/slony2.png" alt="" height="768" width="1024"></a></p>
<p>O seu primeiro nó a ser cadastrado será o no de origem de toda a replicação, chamado de origin node!!!<br>
No nosso caso o no1…</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony3.png"><img class="alignnone size-medium wp-image-28" title="slony3" src="PostgresqlSlony_arquivos/slony3.png" alt="" height="768" width="1024"></a></p>
<p>Digite um nome para o no: no1</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony4.png"><img class="aligncenter size-full wp-image-29" title="slony4" src="PostgresqlSlony_arquivos/slony4.png" alt="" height="768" width="1024"></a></p>
<p>Qual o ip do no1?? Bem como ja vamos rodar na maquina local os dois bancos colocaremos: localhost<br>
PS: como estamos em um exemplo simples posso colocar localhost, mas 
prefira sempre colocar o Endereço ip correspondente da maquina.</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony5.png"><img class="alignnone size-full wp-image-30" title="slony5" src="PostgresqlSlony_arquivos/slony5.png" alt="" height="768" width="1024"></a></p>
<p>Digite o nome do usuário para se conectar no no1: tasca o postgresql…</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony6.png"><img class="alignnone size-full wp-image-31" title="slony6" src="PostgresqlSlony_arquivos/slony6.png" alt="" height="768" width="1024"></a></p>
<p>Qual o banco do nó no1 que eu desejo replicar?? Seria o BD1??? sim sim sim</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony7.png"><img class="alignnone size-full wp-image-32" title="slony7" src="PostgresqlSlony_arquivos/slony7.png" alt="" height="768" width="1024"></a></p>
<p>Cadastre outro nó meu jovem!!!!</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony8.png"><img class="alignnone size-full wp-image-33" title="slony8" src="PostgresqlSlony_arquivos/slony8.png" alt="" height="768" width="1024"></a></p>
<p>Rapaz que cabra inteligente…. Cadastrei o meu primeiro nó, o nó de 
origem entao todos os meus outros nós que irei cadastrar serão nós que 
receberam a replicação. A telinha informa: Agora meu jovem vamos 
cadastrar os nós que receberão a replicação.</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony9.png"><img class="alignnone size-full wp-image-34" title="slony9" src="PostgresqlSlony_arquivos/slony9.png" alt="" height="768" width="1024"></a></p>
<p>Digite um nome para o nó: no2</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony10.png"><img class="alignnone size-full wp-image-35" title="slony10" src="PostgresqlSlony_arquivos/slony10.png" alt="" height="768" width="1024"></a></p>
<p>Digite o ip onde esta o no2: Localhost</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony11.png"><img class="alignnone size-full wp-image-36" title="slony11" src="PostgresqlSlony_arquivos/slony11.png" alt="" height="768" width="1024"></a></p>
<p>postgres … ( to cansando pgcon lá vou eu!!!)</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony12.png"><img class="alignnone size-full wp-image-37" title="slony12" src="PostgresqlSlony_arquivos/slony12.png" alt="" height="768" width="1024"></a></p>
<p>Escolha o bd2, é onde os dados do b1 serão replicados para o bd2!!!</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony14.png"><img class="alignnone size-full wp-image-38" title="slony14" src="PostgresqlSlony_arquivos/slony14.png" alt="" height="768" width="1024"></a></p>
<p>Devemos cadastrar outro nó?? Não Não…..</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony151.png"><img class="alignnone size-full wp-image-40" title="slony151" src="PostgresqlSlony_arquivos/slony151.png" alt="" height="768" width="1024"></a></p>
<p>Eita eu posso até escolher o esquema em que meus objetos estao!!! Sim
 as nossas 20 tabelas estao no esquema public, entao vamos escolher o 
esquema publico!!!</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony16.png"><img class="alignnone size-full wp-image-41" title="slony16" src="PostgresqlSlony_arquivos/slony16.png" alt="" height="768" width="1024"></a></p>
<p>Vamos configurar para replicar as 20 tabelas do banco bd1 para o bd2!!! Escolha as 20 tabelas!!!</p>
<p><a href="http://joaocosme.files.wordpress.com/2008/09/slony17.png"><img class="alignnone size-full wp-image-42" title="slony17" src="PostgresqlSlony_arquivos/slony17.png" alt="" height="768" width="1024"></a></p>
<p>Atenção, que vai ser o meu provedor para o no2?? no nosso Exemplo só 
temos o nó1. Se tivessemos cadastrados mais nós, é nesse menu que eu ia 
definir a minha topologia. Marcamos o no1. Ou seja o meu no2 irá 
replicar através do no1. Mais uma vez, é aqui que definimos quem vai 
cascatear de quem…<br>
<em><br>
</em><br>
Beleza a configuração do slony realmente já esta feita, mas vamos colocar o trem pra funfar, que é o que interessa….</p>
<h3><strong>Acabou….. boa sorte………</strong></h3>
<p>Depois que rodamos o script ele gerou uns arquivos de configuração do
 slony (Aconselho dar uma bizoiada neles para ver o trabalho que dá 
configurar o bicho na unha):<br>
<strong>addPath.sk createSet.sk subscribe.sk iniCluster.sk no1.slon no2.slon pg_service.conf preamble.sk</strong></p>
<p>Não irei entrar em detalhes desses arquivos e sua configuração, mesmo porque o script já fez a configuração todinha…</p>
<p><strong>vamos la:</strong></p>
<p>copie o arquivo <strong>pg_service.conf </strong>para ../pgsql/etc no meu caso <strong>/usr/local/pgsql/etc</strong>,
 provavelmente não existe o diretório etc dentro do /usr/local/pgsql/, 
crie ele e não se esqueça de manter a permissão do diretório e do 
arquivo para postgres. Isso em todos os hosts, ou seja todos os nós do 
cluster.</p>
<p><strong>chmod 750 *.sk </strong>, com isso tornarei todos os meus scripts executaveis</p>
<p>rode os scrips na seguinte ordem:<br>
<strong>./iniCluster.sk<br>
./addPath.sk<br>
./createSet.sk iniCluster.sk<br>
./subscribe.sk</strong></p>
<p><strong>Rode o deamon dos slony:</strong><br>
no caso como faremos localmente abra 2 terminais:<br>
terminal 1: <strong>slon -f ../caminho../no1.slon</strong><br>
terminal 2: <strong>slon -f ../caminho../no2.slon</strong></p>
<h3><strong>Para finalizar…..</strong></h3>
<p>Para quem quiser fazer um shell para inserir 10000 linhas na tabela1 do banco1<br>
for i in $(seq 1 10000)<br>
do<br>
psql -U postgresql -h localhost -c” insert into tabela1 values($i);” bd1<br>
done</p>
<p>ou insira na mao alguns registros.<br>
Depois conecte-se no banco bd2 e:<br>
select count(*) from tabela1;</p>
				</div>
                    
			<p class="category">Enviado em <a href="http://pt-br.wordpress.com/tag/postgresql/" title="Ver todos os posts em Postgresql" rel="category tag">Postgresql</a> |    <a href="http://joaocosme.wordpress.com/2008/09/22/configurando-o-slony-na-manha/#comments" title="Comentário para Configurando o Slony na&nbsp;manha…">2 Comentários »</a></p>
		</div>
	
			<div class="post-19 post type-post status-publish format-standard hentry category-postgresql" id="post-19">
			<h2><a href="http://joaocosme.wordpress.com/2008/07/04/grant-to-usuario/" rel="bookmark" title="Permanent link to Grant *.* to&nbsp;usuário……">Grant *.* to&nbsp;usuário……</a></h2>

			<p class="date">Posted by joaocosme em julho 4, 2008</p>
                   
				<div class="entry">
					<p>Ontem lá pelas tantas da madruga, dando um rolé pelos sites me deparei com o site do <a href="http://www.depesz.com/">depesz</a>
 Fazia um tempinho que eu não acessava o site do cara, meu irmão o cara é
 #”!$%% !!! Pra quem conhece o blog do cara sabe que ele manda muito bem
 !!!!</p>
<p>Bom…. já rasguei a seda…….. Um dos artigos ,o cara comentava da 
dificuldades dos novos dbas postgresql em dar um GRANT/REVOKE em todas 
as tabelas do banco de dados. </p>
<h1><strong>A Saga do Guerreio Paulo César (PC Boy) !!</strong></h1>
<p>Me lembrei do cabra aqui do trampo, grande amigo meu que trabalha 
aqui detentor da seguinte fala “Deixa eu chegar chegando pra não ficar 
ficando , aproveitar o embalo e passar batido” <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"> .</p>
<p> Um dos bancos aqui tem umas 400 tabelas e ele ia uma por uma, em uma luta infernal.</p>
<p>  Grant select,insert,update,delete on tabela1 to usuario;<br>
  Grant select,insert,update,delete on tabela2 to usuario;<br>
  ……<br>
  Grant select,insert,update,delete on tabela400 to usuario;</p>
<p>hehehheheehehee engraçado! Mas eu já passei por isso e pode até parecer uma coisa simples ou idiota, mas….</p>
<h1><strong>AAAAAAA mais o pgadmin faz isso, automaticamente!!!!</strong></h1>
<p>É mesmo!!! Faz, mas e se você por necessidade só tem um “SIMPLES” 
shell hehehe?? KD o seu pgadmin? Tipo o servidor de Banco de dados não 
tem ambiente gráfico e tal…</p>
<p>No site do DESPEZ ele tinha bolado uma stored procedure que dava um grant all *.*, muito legal, vale a pena da uma olhada!!!<br>
Eu sempre tinha resolvido esse tipo de problema fazendo um shell 
scriptzinho, mas como eu nunca salvo as coisas tinha que fazer toda vez 
que era necessário!!</p>
<p><strong><br>
</strong></p><h1><strong>PG_grantall</strong></h1>
<p><strong></strong><br>
Eu não vou negar, shell script RuleZ!!! Gosto do bash, me sinto acolhido
 naquele lugar escuro e quentinho hehehhee. Tava meio enferrujadão de 
shell script e resolvi escrever um script  para automatizar esses grants
 , na verdade não foi nem muito pra ajudar o jovem PC, foi pra relembrar
 algumas coisas mesmo hehehhe, coloquei o nome dele de pg_grantall.</p>
<p># pg_grantall <strong>-h</strong><br>
  <strong> pg_grantall [OPTIONS]</strong></p>
<p><strong>   OPTIONS<br>
   -T GRANT on tables on  database<br>
   -S GRANT on sequences on database<br>
   -U login user<br>
   -H Hostname<br>
   -R Role to grant</strong></p>
<p>Por exemplo: Quero dar os todos os privilegios nas tabelas do banco de dados banco1, para o jovem paulo.</p>
<p><strong>pg_grantall -T -U postgres -H localhost -R paulo banco1</strong></p>
<p>Por exemplo: Quero dar os todos os privilegios nas sequences do banco de dados banco1, para o jovem paulo novamente.</p>
<p><strong>pg_grantall -S -U postgres -H localhost -R paulo banco1</strong></p>
<p>Por exemplo: Quero dar os todos os privilegios nas sequences e também nas tabelas do banco de dados banco1, para o jovem paulo </p>
<p><strong>pg_grantall -ST -U postgres -H localhost -R paulo banco1</strong></p>
<p>Pra quem quizer da uma olhada, sinta-se a vontade, inclusive para adaptá-lo.<br>
Como sempre ando meio cansado, e reconheço que o código não está essa coca-cola toda, poderia estar melhor mas ta aí.</p>
<p><u>pg_grantall</u></p>
<pre><font size="2">
#!/bin/bash   

MENSAGEM=" $(basename "$0") [OPTIONS]
	OPTIONS:

	-T 	Grant tables in  database
	-S      Grand sequences in database
	-U      login user
	-H      hostname
	-R      role to grant. "

while getopts ":TSU:H:hR:" opcao
do
	case $opcao  in
		T) TABLES="r";;
		S) SEQUENCES="S";;
		U) USERDB=$(echo "$OPTARG");;
		H) HOST=$(echo "$OPTARG");;
		R) ROLE=$(echo "$OPTARG");;
		h) echo "$MENSAGEM";exit;;
		\?) echo "Invalid Option!!";exit;;
		: ) echo "Argument missing!!;exit";;

	esac

done

shift $((OPTIND -1))

if [   -z "$TABLES" -a  -z "$SEQUENCES" ]
then
	echo "Missing option T  or S"
	exit
fi

if [ -z "$USERDB" ]
then
	USERDB="postgres"

fi

if [ -z "$HOST" ]
then

	HOST="localhost"
fi

if [ -z "$ROLE" ]
then
	echo "what role should i give the privilleges?"
	exit;
fi 

if [ -z "$*" ]
then
       echo "What database should i connect ??"
       exit;	

fi

echo "Password for user $USERDB: "
read -s PASSWD 

PGPASSWORD=$(echo "$PASSWD")
export  PGPASSWORD

psql -U $USERDB -h $HOST -t  -c "select relname from pg_class where relkind
 in ('$TABLES','$SEQUENCES') and relname !~ '^(pg_|sql)';"   $*  | grep -v "^$" |
 while read linha
do
	psql -U $USERDB -h $HOST -c "grant all on $linha to $ROLE;"   $*
done
</font></pre>
<p><font size="2"></font></p>
<p>Eu coloquei esse script no meu /usr/local/pgsql/bin e ficou legalzin!!</p>
				</div>
                    
			<p class="category">Enviado em <a href="http://pt-br.wordpress.com/tag/postgresql/" title="Ver todos os posts em Postgresql" rel="category tag">Postgresql</a> |    <a href="http://joaocosme.wordpress.com/2008/07/04/grant-to-usuario/#comments" title="Comentário para Grant *.* to&nbsp;usuário……">2 Comentários »</a></p>
		</div>
	
			<div class="post-18 post type-post status-publish format-standard hentry category-postgresql" id="post-18">
			<h2><a href="http://joaocosme.wordpress.com/2008/07/03/comecando-com-o-plproxy/" rel="bookmark" title="Permanent link to Começando com o&nbsp;PLPROXY….">Começando com o&nbsp;PLPROXY….</a></h2>

			<p class="date">Posted by joaocosme em julho 3, 2008</p>
                   
				<div class="entry">
					<p>Esse post é baseado no próprio <a href="http://plproxy.projects.postgresql.org/doc/tutorial.html">tutorial do PL/PROXY </a>e um HOW TO do <a href="http://kaiv.wordpress.com/2007/07/27/postgresql-cluster-partitioning-with-plproxy-part-i/">Kristo Kaiv.</a></p>
<p>Depois de muito tempo, realmente sentei e prometi pra mim mesmo que 
iria conhecer o plproxy. Ontem resolvi dedicar algum tempo a ele, e acho
 que foi um tempo muito bem aproveitado. Bem vamos lá!<br>
A primeira vista o tutorial do próprio projeto me pareceu bastante 
fraco, e demorei um pouco para absorver as particularidades do projeto.</p>
<h1><strong>Para que serve o  particionamento?</strong></h1>
<p>Particionamento possibilita balancear a carga e os dados em múltiplos bancos de dados.</p>
<h1><strong> Entendi mas não to vizualizando…</strong></h1>
<p>Imagine o seguinte cenário:<br>
Você tem uma tabela de login, com milhões de registros, e diariamente 
milhões de usuário se conectam no seu banco de dados. Então você tem uma
 carga muito alta em cima desse servidor e consequentemente muitos dados
 em uma única tabela.</p>
<h1><strong>Beleza mas o que eu poderia fazer então??</strong></h1>
<p><strong></strong><br>
Poderíamos particionar essa tabela de login em vários servidores 
baseados em um determinado critério , no nosso exemplo poderia ser a 
primeira letra do login usuário. Exemplo: usuários de A-J servidor1, 
usuário de K-Z servidor2. Com isso diminuiríamos o LOAD em cima de um 
único servidor e promoveríamos o particionamento dos dados entre os 
servidores.</p>
<h1><strong>Mas como é feito esse particionamento Hein Hein Hein?</strong></h1>
<p><strong></strong><br>
O caso mais comum de particionamento é realizado em cima de hash na 
chave primário, no nosso caso o login do usuário. Usando uma função 
hash, a carga vai sendo balanceada entre as partições.</p>
<p>Exemplo: Suponhamos que temos 2 partições, ou seja dois servidores e a
 nossa tabelinha de login está particionada entre os servidores. 
Usuários de A-J no servidor1 e usuários de K-Z no servidor2.<br>
Então é aplicada uma função hashtext(’login’) que determina a partição que o login do usuário estará:</p>
<p>Sugiro que o leitor entre no banco de dados e faça os seguintes testes:<br>
<strong> select @(hashtext(’joao’)%2 = 1</strong><br>
<strong> selet @(hashtext(’cosme’)%2 = 0</strong><br>
<strong> select @(hashtext(’lindao’)%2 = 1</strong></p>
<p>O número 0 corresponde a primeira partição, e o 1 a segunda.<br>
PS: eu sei que você digitou lindão heehe <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"><br>
Bem, o que ta acontecendo, através de um hash aplicado em um login eu 
determino em que partição se encontra o dado!!!! ok!!! mais se forem 4 
partições??</p>
<p><strong>select @(hashtext(’joao’)%4 = 1</strong><br>
<strong> select @(hashtext(’cosme’)%4 = 0</strong><br>
<strong> selet @(hashtext(’junior’)%4 = 3<br>
select @(hashtext(’lindao’)%4 = 2</strong></p>
<p>Isso tudo é só pra explicar como vai ser particionado e balanceado os
 dados e as cargas nos servidores, pois na configuração isso fica 
transparente.</p>
<h1><strong>O que é um PROXY?</strong></h1>
<p><strong></strong><br>
Bem, eu costumo dizer que um proxy faz o serviço sujo pra vocÊ!!!!! Você
 se conecta em um servidor que vai servir como proxy de banco de dados e
 esse server se conecta nas partições.</p>
<h1><strong>Como funciona PLPROXY?</strong></h1>
<p>O plproxy é uma linguagem criada dentro de um banco de dados 
postgresql (assim como outras linguagens como plpgsql…. ) Possibilitando
 um acesso remoto em outros databases assim como o dblink. Segundo Kaiv,
 o plproxy é um <strong>dblink ANABOLIZADO</strong>! (hehehe não foi que quem disse isso) mas concordei.</p>
<p>A primeira coisa quando eu vi a definição acima, sobre plproxy, que é
 uma linguagem lálálá lalá lálaá que possibilita que eu me conecte em 
outros databases remotos ,não vi nenhuma vantagem em relação ao dblink, e
 questionei, mas depois eu vi claramente <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<h1><strong>Instalando o plproxy</strong></h1>
<p>Você pode baixar os fontes na página do projeto :http://pgfoundry.org/projects/plproxy/:<br>
Como eu estou utilizando o debian 4.0, eu já tenho instalado os pacotes de compilação (make,gcc…..)<br>
caso você não tenha utilize:<br>
<strong><em> apt-get install build-essentials:</em></strong></p>
<p>Antes de iniciar coloque no PATH o caminho para o pg_config</p>
<p><strong><em>PATH:=$PATH:/usr/local/pgsql/bin</em></strong></p>
<p>Baixado o fonte, <em>tar -xzvf plproxy…. </em>, entre no diretório <em>make</em> e depois <em>make install</em>.<br>
Se por acaso ocorreram erros na compilação reclamando do flex e do bison,<br>
<strong> apt-get install flex bison</strong><br>
(Essa vai pro marins hehheh)</p>
<p>Se tudo ocorrer certinho vamos ter o arquivo <strong><em>/usr/loca/pgsql/share/contrib/plproxy.sql</em></strong></p>
<h1><strong>Criando o ambiente!!!</strong></h1>
<p><strong></strong><br>
Vamos fazer o seguinte: iremos criar 4 databases localmente:</p>
<p>create database bdproxy;<br>
create database bd1;<br>
create database bd2;<br>
create database bd3;</p>
<p>Criaremos uma tabela “usuarios” que conterá o login e o mail de cada 
usuário do nosso sistema. Essa tabela deve ser criada no bd1, bd2, bd3.</p>
<p>create table usuarios(login text,mail text);</p>
<p>O cliente se conecta no bdproxy, e ele particiona os dados e faz o balanceamento nos outros servidores.</p>
<p>Criado todos os bancos de dados e a tabela usuarios em cada um deles, vamos dar suporte somente no bdproxy a linguagem plproxy:<br>
<strong> psql -U postgres -h servidor bdproxy &lt; /usr/local/pgsql/share/contrib/plproxy.sql</strong></p>
<p>CREATE FUNCTION<br>
CREATE LANGUAGE</p>
<p>Outro pré-requisito é a criação do eschema plproxy no banco bdproxy;<br>
conectado no banco bdproxy digite:</p>
<p><strong>create schema plproxy;</strong></p>
<h1><strong>Criando o primeiro CLUSTER</strong></h1>
<p>Existem 3 funções que devem ser criadas no banco de dados que servirá como bd_proxy, no caso o bdproxy:</p>
<ul>
<li><strong>plproxy.get_cluster_version(cluster_name)</strong></li>
</ul>
<p>Essa função é chamada em cada requisição, e deve retornar o número da
 versão da configuração corrente para um cluster em particular. Se a 
versão retornada por essa função for maior do que a versão cacheada pelo
 plproxy , então a configuração e as informações sobre  as partições 
irão sofrer um reload na configuração.</p>
<ul>
<li><strong>plproxy.get_cluster_partitions(cluster_name)</strong></li>
</ul>
<p>Essa função é chamada quando uma nova configuração de partição sofre 
um reload. Essa função deve retornar as strings de conexão para as 
partições no cluster. As strings de conexão devem ser retornadas na 
ordem correta. O número total de strings de conexão que devem ser 
retornadas devem ser <strong>potência de 2</strong>.</p>
<p>Se a string string “user=”  não aparecer na string de conexão, entao a
 string user = CURRENT_USER irá ser adicionada na string de conexão pelo
 plproxy.  Então o usuário que se conectou no servidor de proxy irá ser o
 mesmo a ser usados em outros databases. Plproxy não reconhece nenhum 
tipo de password, os databases que serão particionadas devem aceitar a 
conexão do proxy como “TRUST”, se não for requisitado nenhum password. 
Se a string de conexão contém explicitamente um username, então um 
password pode ser setado na string de conexão.</p>
<p>A melhor maneira de explicitar os password é adicionando eles no arquivo.pgpass no diretório home do usuário Postgres.</p>
<ul>
<li><strong>plproxy.get_cluster_config(cluster)</strong></li>
</ul>
<p>Deve retornar parametros de configuração como keys – valores em pares. Todas os parametros são opcionais.</p>
<p>Não se esqueçam , essas 3 (plproxy.get_cluster_version, 
plproxy.get_cluster_partitions, plproxy.get_cluster_config) funções 
devem ficar no banco que servirá como proxy: bdproxy</p>
<p>então abra uma conexão no bdproxy e criaremos essas 3 funções nele:</p>
<pre><font size="2">CREATE OR REPLACE FUNCTION plproxy.get_cluster_version(cluster_name text)
RETURNS int4 AS $$ 

BEGIN 

      IF cluster_name = 'usercluster' THEN 

           RETURN 1;

       END IF; 

    RAISE EXCEPTION 'Cluster Desconhecido';

END;

$$ LANGUAGE plpgsql; 

CREATE OR REPLACE FUNCTION plproxy.get_cluster_partitions(cluster_name text)
RETURNS SETOF text AS 

BEGIN

 IF cluster_name = 'usercluster' THEN
       RETURN NEXT 'dbname=bd1 host=127.0.0.1'; 

       RETURN NEXT 'dbname=bd2 host=127.0.0.1'; 

       RETURN NEXT 'dbname=bd3 host=127.0.0.1';

       RETURN NEXT 'dbname=bd4 host=127.0.0.1'; 

       RETURN; 

END IF;

RAISE EXCEPTION 'Cluster Desconhecido'; 

END;

$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION plproxy.get_cluster_config (cluster_name text,
out key text, out val text)
RETURNS SETOF record AS $$
BEGIN
    RETURN;
END;
$$ LANGUAGE plpgsql;
</font></pre>
<p>Essas são as 3 funções básicas que devem estar no banco que servirá como proxy.</p>
<h1><strong>Eu quero é inserir dados!!!!!<br>
</strong></h1>
<p>Calma jovem!!! Eu sempre fico ansioso quando começo a seguir um how 
to ou tutorial ( principalmente quando o cara gasta umas 2 horas e a 
parada não funfa), então dá uma levantada da cadeira, toma um café e 
VOLTA, para não errarmos nada!!!</p>
<p>Queremos inserir dados nos banco de dados, e logicamente isso 
acontecerá mediante a utilização do bdproxy, ou seja invocaremos uma 
função de inserção no bdproxy e ele vai fazer o balanceamento nos 
databases particionados.</p>
<p>Então vamos criar a função de insert no bdproxy.</p>
<pre><font size="2">CREATE OR REPLACE FUNCTION insert_user(username text, mail text)
RETURNS integer AS $$
     CLUSTER 'usercluster';
     RUN ON hashtext(username);
$$ LANGUAGE plproxy;
</font></pre>
<p>É através dessa função que os dados serão inseridos nos bancos de dados. Explicando um detalhe:</p>
<p><strong>CLUSTER</strong> – é o nome do cluster que nós setamos lá no plproxy.get_cluster_version</p>
<p><strong>RUN ON hashtext (username) </strong>- Agora sim…… O 
particionamento acontece aqui, lembra da função hash  lá em cima???? ou 
seja baseado no username ocorre obtemos  um balanceamento nos servidores
 <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"> , Esse parametro é muito importante.</p>
<p>Agora em cada um dos servidores, bd1. bd2, bd3 , bd4</p>
<p>crie a seguinte função:</p>
<pre><font size="2">CREATE OR REPLACE FUNCTION insert_user(username text, mail text)
RETURNS integer AS $$
     INSERT INTO usuarios VALUES ($1,$2);
     SELECT 1;
$$ LANGUAGE SQL;
</font></pre>
<p><font size="2"></font><br>
Agora vamos inserir os dados efetivamente…..</p>
<p>Elaborei esse shell script para automatizar a inserção, você pode 
inserir diretamente no bdproxy usando seu cliente de preferência.</p>
<p>Digite isso no shell:<br>
for i in $(seq 1 50000)<br>
do<br>
psql -U postgres -h localhost -c ” select insert_user(‘usuario$i’,'usuario$i@mail.com.br’);” bdproxy<br>
done</p>
<p>Então inserimos 50000 registros. Após inserirmos os registros vamos 
contar o número de tuplas da tabela usuarios em cada um dos databases;</p>
<p>bd1 —&gt; select count(*) from usuarios = 12455<br>
bd2 —&gt; select count(*) from usuarios = 12528<br>
bd3 —&gt; select count(*) from usuarios = 12400<br>
bd4 —&gt; select count(*) from usuarios = 12617</p>
<p>Somando um total de 50000 <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
<h1>KD meus dados???  BABY come back to meeee</h1>
<p>Beleza, inserimos os dados e podemos observar que eles estão 
particionados.  E agora como recuperaríamos esses dados?  Bem, da mesma 
forma que o bdproxy particiona os dados utilizando a função hash , 
baseando-se no mesmo hash ele sabe em quais partições estão os dados.</p>
<p>Então no bdproxy vamos escrever a seguinte função:</p>
<pre><font size="2">create or replace function get_user_mail (username text) returns text as $$

        CLUSTER 'usercluster';

        RUN ON hastext(username);

        select mail from usuarios where login = username;

$$ language plproxy;
</font></pre>
<p><font size="2"></font><br>
E para finalizar, (porque eu já estou cansado pra caramba…) no banco bdproxy :</p>
<p>select get_user_mail(‘usuario40′);</p>
<h1><strong>Considerações finais</strong></h1>
<p>Ainda faltam alguns detalhes sobre a ferramenta nesse post, mas para o
 começo acho que está ótimo!!! Prometo que daqui a 1/2 dias eu posto o 
resto!!</p>
<p>Uma boa lida no tutorial do plproxy e do how to do kristo são 
indispensáveis, acho que com esse post já possibilita um entendimento 
muito bom !!!</p>
<p>A ferramente me paraceu muito interessante, principalmente quando 
integramos com o pgbouncer e o londiste ou slony, mas esse post fica pra
 próxima.</p>
<p>Como eu disse no início, eu estou iniciando os estudos em cima do 
plproxy, ainda estou imaginando uma arquitetura bem legal pra 
implementar com mais maturidade e realizar alguns testes.</p>
				</div>
                    
			<p class="category">Enviado em <a href="http://pt-br.wordpress.com/tag/postgresql/" title="Ver todos os posts em Postgresql" rel="category tag">Postgresql</a> |    <a href="http://joaocosme.wordpress.com/2008/07/03/comecando-com-o-plproxy/#comments" title="Comentário para Começando com o&nbsp;PLPROXY….">8 Comentários »</a></p>
		</div>
	
			<div class="post-17 post type-post status-publish format-standard hentry category-postgresql" id="post-17">
			<h2><a href="http://joaocosme.wordpress.com/2008/07/01/automatizando-delecao-de-databases/" rel="bookmark" title="Permanent link to Automatizando deleção de&nbsp;databases…">Automatizando deleção de&nbsp;databases…</a></h2>

			<p class="date">Posted by joaocosme em julho 1, 2008</p>
                   
				<div class="entry">
					<p>Hoje surgiu uma situação um pouco que anormal. O banco de 
desenvolvimento estava gigantesco com vários databases que sinceramente 
mais pareciam um depósitco de lixo em vez de repositório de dados. O 
mais interessante é que todos os databases que deveriam ser apagados 
tinham uma maneira de serem identificados pelo nome: começavam com <strong>bd </strong>e terminavam com <strong>old.</strong></p>
<p><strong>ex: bd_sistema1_old</strong></p>
<p>Então vamos lá:</p>
<p>PS: Logicamente eu utilizo GNU/linux</p>
<p>psql -U postgres -h servidor -t -c “<strong>select datname from pg_database where datname ~ ‘^bd.*old$’</strong> ” postgres   | while read databases</p>
<p>do</p>
<p>psql -U postgres -h servidor -c “drop database $databases;” postgres</p>
<p>done</p>
				</div>
                    
			<p class="category">Enviado em <a href="http://pt-br.wordpress.com/tag/postgresql/" title="Ver todos os posts em Postgresql" rel="category tag">Postgresql</a> |    <a href="http://joaocosme.wordpress.com/2008/07/01/automatizando-delecao-de-databases/#comments" title="Comentário para Automatizando deleção de&nbsp;databases…">1 Comentário »</a></p>
		</div>
	
			<div class="post-16 post type-post status-publish format-standard hentry category-postgresql tag-postgresql" id="post-16">
			<h2><a href="http://joaocosme.wordpress.com/2008/06/27/shell-script-para-backup-de-wal-files/" rel="bookmark" title="Permanent link to Shell script para backup de Wal&nbsp;Files!">Shell script para backup de Wal&nbsp;Files!</a></h2>

			<p class="date">Posted by joaocosme em junho 27, 2008</p>
                   
				<div class="entry">
					<p>Esse é um simples shell script que eu utilizo juntamente com o 
crontab para realizar meus backups de arquivos wal. Para que não sabe do
 que se trata depois eu posto como se configura!!!</p>
<p><strong>PS: Eu agendo uma fez por semana!</strong></p>
<p>#!/bin/bash</p>
<p>#### Diretório de dados do postgresql ######<br>
PGDATA=/data<br>
SAVE_BASE_DIR=/home/postgres/arquivosbase<br>
data=$(date +’%d%m%y’)</p>
<p>#### Diretorio setado para o Wal Files no postgresql.conf ####<br>
WAL_DIR=/wallfiles</p>
<p>### A cada novo backup ele remove Diretorio $WAL_DIR/anterior ###<br>
rm  $WAL_DIR/wal_anterior/*</p>
<p>### Move os Wal gerados anterior e salva para caso de falha #####<br>
mv  /$WAL_DIR/* /$WAL_DIR/wal_anterior</p>
<p>export PGPASSWORD=”password”<br>
psql -U postgres -h localhost -c ‘select pg_start_backup(‘$data’);’ template1 &amp;&amp; \<br>
tar -czvf $SAVE_BASE_DIR/$data.tar.gz $PGDATA &amp;&amp; psql -U postgres -h localhost -c ‘select pg_stop_backup();’ template1</p>
				</div>
                    
			<p class="category">Enviado em <a href="http://pt-br.wordpress.com/tag/postgresql/" title="Ver todos os posts em Postgresql" rel="category tag">Postgresql</a> | Tagged: <a href="http://pt-br.wordpress.com/tag/postgresql/" rel="tag">Postgresql</a> |    <a href="http://joaocosme.wordpress.com/2008/06/27/shell-script-para-backup-de-wal-files/#respond" title="Comentário para Shell script para backup de Wal&nbsp;Files!">Deixar um comentário » </a></p>
		</div>
	
			<div class="post-10 post type-post status-publish format-standard hentry category-postgresql" id="post-10">
			<h2><a href="http://joaocosme.wordpress.com/2008/06/24/rapidinhas-do-pg_dump-sed/" rel="bookmark" title="Permanent link to Rapidinhas do pg_dump +&nbsp;SED">Rapidinhas do pg_dump +&nbsp;SED</a></h2>

			<p class="date">Posted by joaocosme em junho 24, 2008</p>
                   
				<div class="entry">
					<p>Hoje um desenvolvedor pediu que eu copiasse uma determinada 
tabela de um banco de dados ,criasse a bendita  em outro banco de dados 
com outro nome . Tarefa simples, principalmente quando utilizamos o 
poderoso <strong>SED.</strong></p>
<p>pg_dump -U usuario -h servidor1 -t tabela banco1 | <em>sed ‘s/tabela/tabela_temp/g’ </em>| psql -U usuario -h servidor2 banco2</p>
<p> <img src="PostgresqlSlony_arquivos/icon_smile.gif" alt=":)" class="wp-smiley"> </p>
				</div>
                    
			<p class="category">Enviado em <a href="http://pt-br.wordpress.com/tag/postgresql/" title="Ver todos os posts em Postgresql" rel="category tag">Postgresql</a> |    <a href="http://joaocosme.wordpress.com/2008/06/24/rapidinhas-do-pg_dump-sed/#respond" title="Comentário para Rapidinhas do pg_dump +&nbsp;SED">Deixar um comentário » </a></p>
		</div>
	
		
	<div class="bottomnavigation">
		<div class="alignleft"></div>
		<div class="alignright"></div>
	</div>
		
	
</div>

</div>
<div class="clearingdiv">&nbsp;</div>
</div>

<div id="footer">
<a href="http://pt-br.wordpress.com/?ref=footer" rel="generator">Blog no WordPress.com</a>. | Theme: <a href="http://theme.wordpress.com/themes/andreas09/">Andreas09</a> by <a href="http://andreasviklund.com/" rel="designer">Andreas Viklund</a>.</div>

<script type="text/javascript">
// <![CDATA[
(function() {
try{
  if ( window.external &&'msIsSiteMode' in window.external) {
    if (window.external.msIsSiteMode()) {
      var jl = document.createElement('script');
      jl.type='text/javascript';
      jl.async=true;
      jl.src='/wp-content/plugins/ie-sitemode/custom-jumplist.php';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jl, s);
    }
  }
}catch(e){}
})();
// ]]>
</script><script type="text/javascript">_qoptions={qacct:'p-18-mFEk4J448M',labels:'language.pt-br,type.wpcom'};</script>
<script type="text/javascript" src="PostgresqlSlony_arquivos/quant.js"></script>
<noscript><p><img class="robots-nocontent" src="http://pixel.quantserve.com/pixel/p-18-mFEk4J448M.gif?labels=language.pt-br%2Ctype.wpcom" style="display:none" height="1" width="1" alt="" /></p></noscript>
<script type="text/javascript" src="PostgresqlSlony_arquivos/gprofiles.js"></script>
<script type="text/javascript">
/* <![CDATA[ */
var WPGroHo = {
	my_hash: ""
};
/* ]]> */
</script>
<script type="text/javascript" src="PostgresqlSlony_arquivos/wpgroho.js"></script>
	<div style="display: none;">
	</div>
<script type="text/javascript" src="PostgresqlSlony_arquivos/beacon.js"></script><script type="text/javascript">try{COMSCORE.beacon({c1:2,c2:7518284});}catch(e){}</script><noscript><p class="robots-nocontent"><img src="http://b.scorecardresearch.com/p?cj=1c1=2&#038;c2=7518284" alt="" style="display:none" width="1" height="1" /></p></noscript><script src="PostgresqlSlony_arquivos/w.js" type="text/javascript"></script>
<script type="text/javascript">
st_go({'blog':'3961779','v':'wpcom','user_id':'0','post':'0','subd':'joaocosme'});
ex_go({'crypt':'UE40eW5QN0p8M2Y/RE1LVmwrVi5vQS5fVFtfdHBbPyw1VXIrU3hWLHhmQnBoc1dUQi9QczJPNzk0cW0lOXNSK11ueTktRHkvSXpLMC5mSyZoVDM3LHpSWXZHMiU1S2I5XVdhSyZDeXQvNlpYJjQsS1ZtNGEtbF8sNkxMUGQsVCxUbnlGWCUmJVlSYTUva1VNSEFYS21GSkwyUjEsbGZVbFpSL01wa04/TD9+cl10JjlIWG1BJktmb1UzdUlnZFQsP3pKQw=='});
addLoadEvent(function(){linktracker_init('3961779',0);});
	</script><img id="wpstats" src="PostgresqlSlony_arquivos/g_002.gif" alt=""><img id="wpstats2" src="PostgresqlSlony_arquivos/g.gif" alt="" style="display: none;">

</body></html>