


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
	<html>
	<head>
	 <title>Convert the mysql schema to postgres.</title>
	
	 <script type="text/javascript" src="/wiki/stylesheets/wikibits.js"></script>
	 <style type='text/css'>
  	  /*/*/ /*<![CDATA[*/
	  @import "/inc/default.css";
	  #quickbar { position: absolute; left: 0px; }
	  #article { margin-left: 141px; margin-right: 12px; }
	  a.new, #quickbar a.new { color: #CC2200; }
	  /*]]>*/ /* */
	 </style>

	</head>
	<body>
	
	
	
<div id='content'>

  	<div id='quickbar'>
				<p>
				<A href="/"><img src="/images/lamp.jpg"  border="0" alt="A LAMP Portal"></A></p>
				<br>
				<p>
				<a href="/linux/">Linux</a><br/>
				<a href="/java/">Java</a><br/>
				<a href="/php/">PHP</a><br/>
				<p>
				<hr width="50%">
				<p>
				<a href="/jabber/">Jabber</a><br/>
				<a href="/etc/">etc</a><br/>
				</p>
				<p>
				<A href="http://www.radinks.com"><IMG src="/images/drop-logo100.jpg" 
					width=100 height=100 border=0 style="margin-bottom: 30px; margin-top: 60px"
					 alt="The totally Rad Software Company - Sponsor"></A>
				</p>

	</div>
<div id='topbar'><table width='100%' border='0' cellspacing='0' cellpadding='8'><tr><td class='top' align='left' valign='middle' nowrap='nowrap'><a href='/'><span id='sitetitle'>Site With The Lamp</span></a></td></tr></table>
</div>
<div id='article'>
<h1 align='center'>Moving from mysql to postgres</h1><table class="newboxTable" align="right" clear="left">
 <tr><td class="newboxTitle"  align="center">New Articles</td></tr>
 <tr><td class="newboxText">
 	<p><a href="/php/session.php" >Saving session data in a database.</a></p>
	<p><a href="//linux/rcalsa.php">Mystery of the dead speaker.</a></p>
	<p><a href="/wiki/Readfile_vs_include" >readfile vs include.</a></p>
 </td></tr>
</table>

<p>By now we have made sufficient progress in our attempt of adding pgsql support for Rad User Manager that we were able to login to the system during the last step. We have a few more changes to make, one of the most important tasks is to complete the user signup section.
</p>

<p>Some of our tables have <em>auto_increment</em> fields these are known as sequence fields in postgresql. As you know when a row is inserted into such a table the auto increment field is assigned a sequential number by the database. Sometimes we find that we need to retrieve this number as happens during the sign up process. The mysql_insert_id function of PHP is what is being currently used for this purpose but unfortunately the postgres functions of PHP does not include an equivalent.
</p>

<p>Fortunately postgres includes a currval() function which can be used to find the last value picked off the sequence, but before we make use of it we need to side track a bit because the automatically assigned value is meaningless for us if an error was encountered when executing the query. Therefor we need to polish up the error handling before we make use of currval.
</p>


<pre>
	
	function db_error_log()
	{
		global $db_type;
		
		
		if($db_type == 'mysql' && mysql_errno() != 0)
		{
			$errMessage = mysql_error();
			error_log($errMessage);
			return $errMessage;
		}
		else
		{
			$errMessage = pg_last_error();
			error_log($errMessage);
			return $errMessage;
		}
	}

</pre>

<p>These few lines of code will log the last error reported by the DB. The is usually written to your webserver log file but check your php.ini settings and your webserver's documentation to be sure. The same message is returned to the calling method.
</p>

<p>Let's do a search and replace for all occurances of mysql_error with our newly build db_error_log. We need to watch for any occurances of mysql_errno as well. Since it's exact equivalent does not exist on the other system we need to make a slight modification to our code.
</p>

<pre>
	$err = db_error_log();
	if($err !='')
	{
		....
	}
</pre>

<p>Now that error handling is out of the way, let's create a function to retrieve the insert id. Notice that it accepts a single parameter which is the name of the sequence in pgsql but needs not be defined in mysql. So we give it a default value.
</p>

<pre>
	function db_insert_id($sequence='')
	{
		global $db_type;
		if($db_type == 'mysql')
		{
			return mysql_insert_id();
		}
		else
		{
			$result = pg_query("SELECT currval('$sequence')");
			if($result)
			{
				$row = pg_fetch_row($result);
				return $row[0];
			}
		}
	}
</pre>

<p>Since we already have quite three snippets of code on this page let's not overload it with another sample on how we should change calls to mysql_insert_id but don't forget to make the changes that you will find in the download.</p>

<p>&nbsp;</p>
<div align="center" style="margin-left:-120px">
<table border=0 cellpadding=5>
 <tr><td bgcolor="#e0e0ff"> &nbsp; Part 1: &nbsp; </td>
     <td><a href="/postgres/">Getting Started</a> &nbsp; , &nbsp;
	<a href="/postgres/convert.php">The Schema</a> &nbsp; , &nbsp;
	<a href="/postgres/query.php">Queries</a>
    </td>
 </tr>
 <tr><td bgcolor="#e0e0ff"> &nbsp; Part 2: &nbsp; </td>
     <td><a href="/postgres/password.php">Passwords</a> &nbsp; , &nbsp;
	 <a href="/postgres/timestamp.php">Times Up</a> &nbsp; , &nbsp;
	 <a href="/postgres/error.php">Errors</a> &nbsp; , &nbsp;
	 <a href="/postgres/download.php">Download</a>
     </td>
 </tr>
</table>
</div>

	  </div>
	</div>
	<br clear='all' />
	<div id='footer'>
		<p style="margin-top:30px">&nbsp;</p>		
	    <hr width="45%" align="center">
		<p align="center">		
			<a href="/jabber/">Jabber</a> &nbsp;|&nbsp;
			<a href="/linux/">Linux</a> &nbsp;|&nbsp;
			<a href="/mysql/">mySQL</a> &nbsp;|&nbsp;
			<a href="/php/">PHP</a> &nbsp;|&nbsp;				
			<a href="/java/">Java</a>  &nbsp;|&nbsp;
			<a href="/sitemap.php">Site Map</a> &nbsp;|&nbsp;
			<a href="/wiki/">Wiki</a>
			
		</p>
		<p align="center">					
			<a href="/downloads/">Downloads</a> &nbsp;|&nbsp;
			<a href="/about.php">About</a> &nbsp;|&nbsp;
			<a href="/mysql/links.php">Links</a> &nbsp;|&nbsp;
			<a href="/contact.php">Contact</a> &nbsp;|&nbsp;
			<a href="/">Home</a>
		</p>
		<p>&nbsp;</p>
	   
<script type="text/javascript"><!--
google_ad_client = "pub-6509966129456920";
google_ad_width = 468;
google_ad_height = 60;
google_ad_format = "468x60_as";
google_ad_type = "text_image";
//--></script>
	
	<p align="center">
		<script type="text/javascript"
		src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
		</script>  
	</p>
		<p>&nbsp;</p>
		<p align=center>Copyright &copy; Raditha Dissanayake 2005</p>

		<p align=center  style="font-size:90%" >
		<a href="/terms.php">Terms of Use</a>  &nbsp;|&nbsp;
		<a href="/privacy.php">Privacy</a>
		</p>
	
  </div>
  
 </body>
</html>
